<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Impact Hub - Live Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col" x-data="appData()" x-init="init()">

    <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 w-10 h-10 rounded flex items-center justify-center font-bold text-xl">DC</div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Digital Impact Hub</h1>
                <p class="text-xs text-slate-400">OneDrive Connected</p>
            </div>
        </div>
        
        <div class="flex items-center bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
            <template x-if="!fileHandle">
                <div class="flex items-center gap-2 text-amber-400">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span class="text-xs font-bold uppercase">Not Connected</span>
                </div>
            </template>
            <template x-if="fileHandle">
                <div class="flex items-center gap-2 text-emerald-400">
                    <i class="fas fa-link"></i>
                    <span class="text-xs font-bold uppercase">Live Linked: OneDrive</span>
                </div>
            </template>
        </div>

        <div>
             <template x-if="!fileHandle">
                <button @click="openFile()" class="text-sm bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold shadow transition animate-pulse">
                    <i class="fas fa-folder-open mr-2"></i> Connect Data File
                </button>
             </template>
             <template x-if="fileHandle">
                <button @click="saveToFile()" class="text-sm bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded font-bold shadow transition">
                    <i class="fas fa-save mr-2"></i> Save Changes
                </button>
             </template>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 relative">
        
        <div x-show="!fileHandle" class="max-w-2xl mx-auto mt-20 text-center">
            <div class="bg-white p-10 rounded-xl shadow-xl border-2 border-slate-200">
                <div class="text-6xl text-slate-300 mb-6"><i class="fas fa-cloud-upload-alt"></i></div>
                <h2 class="text-3xl font-bold text-slate-800 mb-4">Connect to OneDrive</h2>
                <p class="text-slate-600 mb-8 leading-relaxed">
                    To ensure your data is secure and backed up, this app connects directly to a file on your computer.<br>
                    Please select your <strong>digital-coach-data.json</strong> file from your OneDrive folder.
                </p>
                <button @click="openFile()" class="bg-blue-600 text-white text-lg px-8 py-4 rounded shadow-lg hover:bg-blue-700 transition transform hover:-translate-y-1">
                    Select File from OneDrive
                </button>
                <p class="text-xs text-slate-400 mt-6">
                    <i class="fas fa-lock"></i> Your data stays on your device. It is not uploaded to GitHub.
                </p>
            </div>
        </div>

        <div x-show="fileHandle" x-transition>
            
            <div class="flex justify-center gap-4 mb-8 border-b border-slate-200 pb-4 no-print">
                <button @click="view = 'dashboard'" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'dashboard'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600">Dashboard</button>
                <button @click="view = 'projects'" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'projects'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600">Projects</button>
                <button @click="view = 'reports'" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'reports'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600">Reports</button>
                <button @click="view = 'settings'" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'settings'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600">Settings</button>
            </div>

            <div x-show="view === 'dashboard'" class="max-w-6xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                        <div class="text-xs font-bold text-slate-400 uppercase">Total Active</div>
                        <div class="text-3xl font-bold" x-text="projects.filter(p=>p.status!=='Completed').length"></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-amber-500">
                        <div class="text-xs font-bold text-slate-400 uppercase">Actions Due</div>
                        <div class="text-3xl font-bold" x-text="getDueTasks().length"></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-emerald-500">
                        <div class="text-xs font-bold text-slate-400 uppercase">Impact Logged</div>
                        <div class="text-3xl font-bold" x-text="activityLog.length"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded p-6 shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Immediate Actions</h3>
                         <template x-if="getDueTasks().length === 0">
                            <p class="text-slate-400 italic text-sm">No tasks due.</p>
                        </template>
                        <div class="space-y-2">
                             <template x-for="task in getDueTasks()" :key="task.id">
                                <div class="flex justify-between items-center p-3 bg-amber-50 border border-amber-100 rounded cursor-pointer hover:bg-amber-100" @click="openProject(task.projectId)">
                                    <div>
                                        <div class="text-sm font-bold text-slate-800" x-text="task.title"></div>
                                        <div class="text-xs text-slate-500" x-text="task.projectName"></div>
                                    </div>
                                    <div class="text-xs font-bold text-amber-700" x-text="formatDate(task.dueDate)"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="bg-indigo-50 rounded p-6 shadow-sm border border-indigo-100">
                        <h3 class="font-bold text-indigo-900 mb-4">Create New</h3>
                        <button @click="startNewProject('coaching')" class="w-full text-left bg-white p-4 rounded shadow-sm mb-3 hover:bg-indigo-100 font-bold text-indigo-800 flex items-center justify-between">
                            <span><i class="fas fa-user-friends mr-2"></i> Coaching Case</span>
                            <i class="fas fa-chevron-right text-xs"></i>
                        </button>
                        <button @click="startNewProject('project')" class="w-full text-left bg-white p-4 rounded shadow-sm hover:bg-indigo-100 font-bold text-indigo-800 flex items-center justify-between">
                            <span><i class="fas fa-project-diagram mr-2"></i> Strategic Project</span>
                            <i class="fas fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div x-show="view === 'projects'" class="max-w-6xl mx-auto">
                <div class="flex justify-between mb-4">
                    <input x-model="searchQuery" placeholder="Search projects..." class="border p-2 rounded w-64">
                    <select x-model="filterPriority" class="border p-2 rounded">
                        <option value="">All Priorities</option>
                        <template x-for="p in settings.priorities">
                            <option :value="p" x-text="p"></option>
                        </template>
                    </select>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="project in filteredProjects" :key="project.id">
                        <div class="bg-white p-4 rounded shadow border hover:shadow-md transition cursor-pointer" @click="editProject(project)">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-slate-800" x-text="project.title"></h3>
                                <span class="text-xs bg-slate-100 px-2 py-1 rounded" x-text="project.type"></span>
                            </div>
                            <p class="text-xs text-slate-500 mb-4" x-text="project.contact"></p>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mb-2">
                                <div class="bg-blue-600 h-1.5 rounded-full" :style="`width: ${calculateProgress(project)}%`"></div>
                            </div>
                            <div class="text-xs text-slate-400 text-right" x-text="calculateProgress(project) + '%'"></div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'reports'" class="max-w-4xl mx-auto">
                <div class="bg-white p-6 rounded shadow mb-6 no-print">
                    <h2 class="font-bold text-lg mb-2">Generate Report</h2>
                    <div class="flex gap-2">
                        <button @click="generateReport('all')" class="bg-slate-800 text-white px-4 py-2 rounded">All Projects</button>
                        <button @click="generateReport('priority')" class="bg-blue-600 text-white px-4 py-2 rounded">By Priority</button>
                    </div>
                </div>
                <div id="print-area" x-show="reportData.length > 0" class="bg-white p-10 shadow-lg min-h-screen">
                    <div class="border-b-2 border-black pb-4 mb-8">
                        <h1 class="text-3xl font-bold uppercase">Impact Report</h1>
                        <p class="text-slate-500">Generated: <span x-text="new Date().toLocaleDateString()"></span></p>
                    </div>
                    <template x-for="grp in reportData" :key="grp.category">
                        <div class="mb-8">
                            <h2 class="text-xl font-bold text-blue-800 border-b border-blue-100 mb-4 pb-1" x-text="grp.category"></h2>
                            <template x-for="p in grp.items">
                                <div class="mb-6 pl-4 border-l-2 border-slate-200">
                                    <div class="flex justify-between">
                                        <h3 class="font-bold text-lg" x-text="p.title"></h3>
                                        <span class="text-sm bg-slate-100 px-2 rounded" x-text="p.status"></span>
                                    </div>
                                    <p class="text-sm text-slate-600 italic mb-2" x-text="p.objective"></p>
                                    <div class="space-y-1">
                                        <template x-for="m in p.milestones">
                                            <div x-show="m.completed" class="flex gap-2 text-sm items-center text-slate-700">
                                                <i class="fas fa-check text-green-500"></i>
                                                <span x-text="m.title"></span>
                                                <a x-show="m.evidenceLink" :href="m.evidenceLink" target="_blank" class="text-blue-600 underline text-xs">Evidence</a>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

             <div x-show="view === 'settings'" class="max-w-2xl mx-auto">
                <div class="bg-white p-6 rounded shadow">
                    <h2 class="font-bold text-lg mb-4">Core Priorities</h2>
                    <div class="space-y-2">
                        <input x-model="settings.priorities[0]" class="w-full border p-2 rounded" placeholder="Priority 1">
                        <input x-model="settings.priorities[1]" class="w-full border p-2 rounded" placeholder="Priority 2">
                        <input x-model="settings.priorities[2]" class="w-full border p-2 rounded" placeholder="Priority 3">
                    </div>
                    <button @click="saveToFile()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Save Settings</button>
                </div>
            </div>

        </div> </main>

    <div x-show="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-cloak>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg">Manage Case</h3>
                <button @click="showModal = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input x-model="currentProject.title" class="border p-2 rounded font-bold" placeholder="Project/Staff Name">
                    <input x-model="currentProject.contact" class="border p-2 rounded" placeholder="Dept / Contact">
                    <select x-model="currentProject.type" class="border p-2 rounded">
                        <option value="coaching">Coaching Case</option>
                        <option value="project">Strategic Project</option>
                    </select>
                    <select x-model="currentProject.priority" class="border p-2 rounded">
                        <option value="">No Priority</option>
                        <template x-for="p in settings.priorities"><option :value="p" x-text="p"></option></template>
                    </select>
                </div>
                <textarea x-model="currentProject.objective" class="w-full border p-2 rounded h-20" placeholder="Objective"></textarea>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between mb-2">
                        <h4 class="font-bold text-sm uppercase text-slate-500">Milestones</h4>
                        <button @click="addMilestone()" class="text-xs bg-slate-200 px-2 py-1 rounded">Add Task</button>
                    </div>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <template x-for="(m, idx) in currentProject.milestones" :key="idx">
                            <div class="flex gap-2 items-start bg-slate-50 p-2 rounded border">
                                <input type="checkbox" x-model="m.completed" class="mt-1.5">
                                <div class="flex-1 space-y-1">
                                    <input x-model="m.title" class="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm font-semibold">
                                    <div class="flex gap-2">
                                        <input type="date" x-model="m.dueDate" class="text-xs bg-transparent">
                                        <input x-model="m.evidenceLink" placeholder="Evidence Link..." class="text-xs w-full bg-transparent text-blue-600">
                                    </div>
                                </div>
                                <button @click="currentProject.milestones.splice(idx, 1)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end gap-2">
                <button @click="showModal = false" class="px-4 py-2 text-slate-500">Cancel</button>
                <button @click="saveProject()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </div>
    </div>

    <script>
        function appData() {
            return {
                view: 'dashboard',
                fileHandle: null, // The magic connection
                showModal: false,
                searchQuery: '',
                filterPriority: '',
                projects: [],
                activityLog: [],
                reportData: [],
                settings: { priorities: ['Foundations', 'Assessment', 'Modelling'] },
                currentProject: {},

                async init() {
                    // We don't load from localStorage automatically anymore
                    // We wait for the user to connect the file
                },

                // --- FILE SYSTEM API ---
                async openFile() {
                    try {
                        const [handle] = await window.showOpenFilePicker({
                            types: [{ description: 'JSON Data', accept: { 'application/json': ['.json'] } }],
                            multiple: false
                        });
                        this.fileHandle = handle;
                        
                        // Read file
                        const file = await handle.getFile();
                        const text = await file.text();
                        
                        if (text.trim()) {
                            const data = JSON.parse(text);
                            this.projects = data.projects || [];
                            this.settings = data.settings || this.settings;
                            this.activityLog = data.log || [];
                        }
                    } catch (err) {
                        console.error('File open failed', err);
                    }
                },

                async saveToFile() {
                    if (!this.fileHandle) return;
                    try {
                        const writable = await this.fileHandle.createWritable();
                        const data = {
                            projects: this.projects,
                            settings: this.settings,
                            log: this.activityLog
                        };
                        await writable.write(JSON.stringify(data, null, 2));
                        await writable.close();
                        
                        // Visual feedback could go here
                        const btn = document.querySelector('button i.fa-save');
                        if(btn) { btn.parentElement.classList.add('bg-green-700'); setTimeout(()=>btn.parentElement.classList.remove('bg-green-700'), 500); }
                        
                    } catch (err) {
                        alert('Failed to save to file. ' + err.message);
                    }
                },

                // --- APP LOGIC ---
                startNewProject(type) {
                    this.currentProject = {
                        id: Date.now(),
                        title: '', contact: '', type: type, priority: '', objective: '', status: 'Active',
                        lastUpdated: new Date().toISOString(),
                        milestones: []
                    };
                    if(type === 'coaching') {
                         this.currentProject.milestones = [
                            { title: 'Discovery', completed: false, dueDate: '', evidenceLink: '' },
                            { title: 'Training', completed: false, dueDate: '', evidenceLink: '' },
                            { title: 'L2 Impact', completed: false, dueDate: '', evidenceLink: '' },
                            { title: 'L3 Impact', completed: false, dueDate: '', evidenceLink: '' }
                        ];
                    }
                    this.showModal = true;
                },
                
                editProject(p) {
                    this.currentProject = JSON.parse(JSON.stringify(p));
                    this.showModal = true;
                },

                saveProject() {
                    const idx = this.projects.findIndex(x => x.id === this.currentProject.id);
                    if (idx === -1) this.projects.push(this.currentProject);
                    else this.projects[idx] = this.currentProject;
                    
                    this.saveToFile(); // Auto save to OneDrive
                    this.showModal = false;
                },

                addMilestone() {
                    this.currentProject.milestones.push({title:'New Task', completed:false, dueDate:'', evidenceLink:''});
                },

                // --- HELPERS ---
                get filteredProjects() {
                    return this.projects.filter(p => {
                        const s = this.searchQuery.toLowerCase();
                        return (p.title.toLowerCase().includes(s) || p.contact.toLowerCase().includes(s)) &&
                               (this.filterPriority === '' || p.priority === this.filterPriority);
                    });
                },
                
                calculateProgress(p) {
                    if(!p.milestones.length) return 0;
                    return Math.round((p.milestones.filter(m=>m.completed).length / p.milestones.length) * 100);
                },

                getDueTasks() {
                    let tasks = [];
                    this.projects.forEach(p => {
                        p.milestones.forEach(m => {
                            if (!m.completed && m.dueDate) tasks.push({id: Math.random(), projectId: p.id, projectName: p.title, title: m.title, dueDate: m.dueDate});
                        });
                    });
                    return tasks.sort((a,b)=>a.dueDate.localeCompare(b.dueDate));
                },
                
                formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB') : ''; },

                generateReport(mode) {
                     if (mode === 'all') {
                        this.reportData = [{ category: 'All Projects', items: this.projects }];
                    } else if (mode === 'priority') {
                        const groups = {};
                        this.projects.forEach(p => {
                            const key = p.priority || 'Uncategorized';
                            if (!groups[key]) groups[key] = [];
                            groups[key].push(p);
                        });
                        this.reportData = Object.keys(groups).map(k => ({ category: k, items: groups[k] }));
                    }
                    setTimeout(() => document.getElementById('print-area').scrollIntoView({behavior:'smooth'}), 100);
                }
            }
        }
    </script>
</body>
</html>
