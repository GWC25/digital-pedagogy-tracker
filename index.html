<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Impact Hub OS v31.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        :root { --p1: #2563eb; --p2: #7c3aed; --p3: #059669; --p4: #db2777; }
        
        /* Calendar Grid Styling */
        .calendar-grid {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            grid-template-rows: 40px repeat(40, 25px); /* 10 hours * 4 slots/hr */
            border: 1px solid #e2e8f0;
        }
        .time-label { grid-column: 1; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #f1f5f9; font-size: 10px; color: #94a3b8; text-align: right; padding-right: 4px; }
        .day-cell { border-right: 1px solid #e2e8f0; border-bottom: 1px solid #f1f5f9; position: relative; }
        .event-card { position: absolute; left: 2px; right: 2px; border-radius: 4px; padding: 4px; font-size: 11px; overflow: hidden; border-left: 3px solid; z-index: 10; cursor: pointer; }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; width: 100%; }
            body { overflow: visible !important; }
        }
    </style>
</head>
<body class="text-slate-800 bg-slate-50 h-screen flex flex-col overflow-hidden" x-data="appData()" x-init="init()">

    <header class="bg-white border-b border-slate-200 h-16 flex justify-between items-center px-6 shadow-sm z-50 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-lg"><i class="fas fa-hubspot"></i></div>
            <div>
                <h1 class="font-bold text-slate-800 leading-none">Digital Impact Hub</h1>
                <p class="text-[10px] text-indigo-500 uppercase tracking-widest font-bold mt-1">Strategy OS v31.0</p>
            </div>
        </div>
        <nav class="hidden lg:flex bg-slate-100 p-1 rounded-xl gap-1">
            <template x-for="item in navItems">
                <button @click="view = item.id" :class="view === item.id ? 'bg-white shadow text-indigo-600' : 'text-slate-500 hover:text-slate-700'" class="px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    <i :class="item.icon"></i> <span x-text="item.label"></span>
                </button>
            </template>
        </nav>
        <div class="flex items-center gap-3">
            <button @click="showDailyUpdate = true" class="bg-amber-500 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-amber-600 shadow-sm"><i class="fas fa-bolt mr-1"></i> Daily Wrap</button>
            <button @click="openFile()" class="text-xs bg-slate-800 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-slate-700 transition"><i class="fas fa-database mr-2"></i> <span x-text="fileHandle ? 'Connected' : 'Connect Data'"></span></button>
        </div>
    </header>

    <main class="flex-1 overflow-hidden relative flex flex-col">
        <div x-show="view === 'strategy'" class="flex-1 overflow-y-auto p-6 space-y-6 animate-fade-in">
            <div class="flex justify-between items-end">
                <h2 class="text-2xl font-bold text-slate-800 text-print">Strategic Pillars <span class="text-slate-400 font-light">2026</span></h2>
                <button @click="exportPDF('strategy')" class="text-xs bg-white border border-slate-300 px-3 py-2 rounded font-bold no-print"><i class="fas fa-file-pdf mr-2 text-red-500"></i> Export Dossier</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <template x-for="prio in settings.priorities" :key="prio.id">
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                        <div class="p-5" :style="`background: linear-gradient(135deg, ${prio.color}11, transparent)`">
                            <div class="flex justify-between items-start mb-4">
                                <span :style="`background: ${prio.color}; shadow: 0 4px 6px ${prio.color}33`" class="text-[10px] text-white px-3 py-1 rounded-full font-black uppercase tracking-widest" x-text="prio.title"></span>
                                <div class="text-2xl font-black text-slate-200" x-text="'0' + prio.id"></div>
                            </div>
                            <p class="text-xs text-slate-500 italic mb-4" x-text="prio.intent"></p>
                            
                            <div class="space-y-3">
                                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Active Projects</div>
                                <template x-for="proj in projects.filter(x => x.priorityId == prio.id)">
                                    <div @click="editProject(proj)" class="flex items-center justify-between p-2 rounded-lg bg-white border border-slate-100 hover:border-indigo-300 cursor-pointer shadow-sm group">
                                        <span class="text-xs font-medium text-slate-700 group-hover:text-indigo-600" x-text="proj.title"></span>
                                        <div class="flex items-center gap-2">
                                            <div class="w-12 h-1 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" :style="`width: ${calculateProgress(proj)}%`"></div></div>
                                            <span class="text-[10px] font-bold text-slate-400" x-text="calculateProgress(proj) + '%'"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="view === 'planner'" class="flex-1 flex overflow-hidden no-print">
            <div class="w-80 bg-white border-r border-slate-200 flex flex-col">
                <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-500">Action Hopper</h3>
                    <button @click="addTodo()" class="text-[10px] bg-indigo-600 text-white px-2 py-1 rounded font-bold hover:bg-indigo-700 shadow">+ ADD</button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    <template x-for="task in todos.filter(t => !t.completed)" :key="task.id">
                        <div draggable="true" @dragstart="dragEvent = task" class="p-3 bg-white border border-slate-200 rounded-xl shadow-sm hover:border-indigo-400 cursor-move transition group">
                            <div class="text-xs font-bold text-slate-800 mb-1" x-text="task.text"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-[9px] text-slate-400 uppercase font-medium" x-text="task.projectTitle || 'Quick Task'"></span>
                                <i class="fas fa-grip-vertical text-slate-200 group-hover:text-slate-400"></i>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex-1 flex flex-col bg-slate-100 overflow-hidden">
                <div class="h-12 bg-white border-b flex items-center px-4 justify-between">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-slate-600">Weekly Performance</span>
                    </div>
                    <div class="flex gap-2">
                        <template x-for="filter in ['Strategy', 'Projects', 'Meetings', 'Activities']">
                            <button class="text-[10px] px-2 py-1 rounded bg-slate-200 font-bold text-slate-500 hover:bg-indigo-100 hover:text-indigo-600" x-text="filter"></button>
                        </template>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="calendar-grid bg-white rounded-xl shadow-lg">
                        <div class="col-start-1 row-start-1 border-r border-b"></div>
                        <template x-for="(day, index) in ['Monday','Tuesday','Wednesday','Thursday','Friday']">
                            <div class="border-r border-b bg-slate-50/50 flex items-center justify-center text-[10px] font-black uppercase text-slate-400" :style="`grid-column: ${index + 2}`" x-text="day"></div>
                        </template>
                        
                        <template x-for="slot in 40"> <div class="time-label" :style="`grid-row: ${slot + 1}`" x-text="getTimeForSlot(slot)"></div>
                        </template>
                        
                        <template x-for="dayIdx in 5">
                            <template x-for="slotIdx in 40">
                                <div class="day-cell" 
                                     :style="`grid-column: ${dayIdx + 1}; grid-row: ${slotIdx + 1}`"
                                     @dragover.prevent=""
                                     @drop="dropOnCalendar(dayIdx, slotIdx)">
                                </div>
                            </template>
                        </template>

                        <template x-for="evt in calendarEvents" :key="evt.id">
                            <div class="event-card" 
                                 :style="getEventStyle(evt)"
                                 :class="evt.type === 'meeting' ? 'bg-amber-50 border-amber-500 text-amber-800' : 'bg-indigo-50 border-indigo-500 text-indigo-800'"
                                 @click="openEvent(evt)">
                                <div class="font-black leading-tight" x-text="evt.title"></div>
                                <div class="text-[9px] opacity-70" x-text="evt.startTime + ' - ' + evt.endTime"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="view === 'reports'" class="flex-1 overflow-y-auto p-8 animate-fade-in print-area">
             <div class="max-w-5xl mx-auto space-y-10">
                 <div class="flex justify-between items-center border-b-2 border-slate-900 pb-4">
                     <div>
                         <h1 class="text-3xl font-black text-slate-900 uppercase">Impact Dossier</h1>
                         <p class="text-slate-500 font-medium">Data Integration & Pedagogy Analysis</p>
                     </div>
                     <button @click="window.print()" class="bg-slate-900 text-white px-6 py-2 rounded-lg font-bold no-print">Download PDF</button>
                 </div>

                 <div class="grid grid-cols-3 gap-6">
                     <div class="bg-indigo-600 text-white p-6 rounded-2xl">
                         <div class="text-sm opacity-80 uppercase font-black">Project Velocity</div>
                         <div class="text-4xl font-black mt-2" x-text="projects.length"></div>
                         <div class="text-xs mt-4">Across 4 Strategic Pillars</div>
                     </div>
                     <div class="bg-emerald-600 text-white p-6 rounded-2xl">
                         <div class="text-sm opacity-80 uppercase font-black">QIP Traction</div>
                         <div class="text-4xl font-black mt-2" x-text="projects.filter(p => p.isQip).length"></div>
                         <div class="text-xs mt-4">Linked to Quality Improvement</div>
                     </div>
                     <div class="bg-slate-800 text-white p-6 rounded-2xl">
                         <div class="text-sm opacity-80 uppercase font-black">Evidence Logged</div>
                         <div class="text-4xl font-black mt-2" x-text="projects.reduce((acc, p) => acc + (p.updates?.length || 0), 0)"></div>
                         <div class="text-xs mt-4">Verified Impact Statements</div>
                     </div>
                 </div>

                 <section class="space-y-4">
                     <h3 class="text-xl font-bold border-l-4 border-indigo-600 pl-4">Pillar Progress & Impact</h3>
                     <table class="w-full border-collapse">
                         <thead>
                             <tr class="bg-slate-100 text-left text-[10px] uppercase font-black text-slate-500">
                                 <th class="p-3">Strategic Pillar</th>
                                 <th class="p-3">Lead Projects</th>
                                 <th class="p-3">Progress</th>
                                 <th class="p-3">Latest Impact Statement</th>
                             </tr>
                         </thead>
                         <tbody class="text-xs">
                             <template x-for="prio in settings.priorities">
                                 <tr class="border-b">
                                     <td class="p-3 font-bold" x-text="prio.title"></td>
                                     <td class="p-3">
                                         <div class="space-y-1">
                                             <template x-for="proj in projects.filter(x => x.priorityId == prio.id)">
                                                 <div x-text="proj.title" class="text-slate-600 italic"></div>
                                             </template>
                                         </div>
                                     </td>
                                     <td class="p-3">
                                         <div class="w-24 h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" :style="`width: ${calculatePriorityProgress(prio.id)}%`"></div></div>
                                     </td>
                                     <td class="p-3 text-slate-500" x-text="getLatestImpact(prio.id)"></td>
                                 </tr>
                             </template>
                         </tbody>
                     </table>
                 </section>
             </div>
        </div>
    </main>

    <div x-show="showDailyUpdate" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-md" x-cloak>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl p-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8 border-b pb-4">
                <div>
                    <h2 class="text-2xl font-black text-slate-800 uppercase italic">Daily Impact Wrap-up</h2>
                    <p class="text-sm text-slate-500">Sync calendar activities to project evidence</p>
                </div>
                <button @click="showDailyUpdate = false" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="space-y-6">
                <template x-for="evt in calendarEvents" :key="evt.id">
                    <div class="grid grid-cols-12 gap-4 p-4 border rounded-2xl bg-slate-50 items-center">
                        <div class="col-span-3 font-bold text-slate-700" x-text="evt.title"></div>
                        <div class="col-span-3">
                            <select class="w-full text-xs border-slate-200 rounded-lg p-2 bg-white" x-model="evt.linkedProjectId">
                                <option value="">Link to Project...</option>
                                <template x-for="p in projects"><option :value="p.id" x-text="p.title"></option></template>
                            </select>
                        </div>
                        <div class="col-span-4">
                            <input type="text" placeholder="Impact statement for this activity..." class="w-full text-xs border-slate-200 rounded-lg p-2" x-model="evt.impact">
                        </div>
                        <div class="col-span-2 flex justify-end">
                            <button @click="syncEventToProject(evt)" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold uppercase tracking-widest shadow-lg">Sync</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function appData() {
            return {
                view: 'strategy',
                fileHandle: null,
                showDailyUpdate: false,
                dragEvent: null,
                projects: [],
                todos: [],
                calendarEvents: [],
                settings: {
                    priorities: [
                        { id: 1, title: 'Digital Ecosystem', intent: 'Consistent college-wide digital baseline.', color: '#2563eb' },
                        { id: 2, title: 'Pedagogy & AI', intent: 'Improving instructional design through AI & Modelling.', color: '#7c3aed' },
                        { id: 3, title: 'Inclusion (SEND)', intent: 'Accessibility by design and universal Assistive Tech.', color: '#059669' },
                        { id: 4, title: 'Capacity & Quality', intent: 'Digital Champions network and governance alignment.', color: '#db2777' }
                    ]
                },
                navItems: [
                    { id: 'planner', label: 'Planner', icon: 'fas fa-calendar-day' },
                    { id: 'strategy', label: 'Strategy', icon: 'fas fa-chess' },
                    { id: 'projects', label: 'Projects', icon: 'fas fa-folder' },
                    { id: 'reports', label: 'Reports', icon: 'fas fa-chart-bar' }
                ],

                async init() {
                    // Auto-mapping logic for old data would go here
                },

                // --- CALENDAR LOGIC ---
                getTimeForSlot(slot) {
                    const startHour = 8;
                    const totalMinutes = (slot - 1) * 15;
                    const hour = startHour + Math.floor(totalMinutes / 60);
                    const mins = totalMinutes % 60;
                    return `${hour.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                },

                dropOnCalendar(dayIdx, slotIdx) {
                    if (!this.dragEvent) return;
                    const startTime = this.getTimeForSlot(slotIdx + 1);
                    const endTime = this.getTimeForSlot(slotIdx + 5); // Default 1hr
                    
                    this.calendarEvents.push({
                        id: Date.now(),
                        title: this.dragEvent.text,
                        day: dayIdx,
                        slotStart: slotIdx + 1,
                        slotSpan: 4, // 1 hour
                        startTime,
                        endTime,
                        type: 'work',
                        linkedProjectId: this.dragEvent.projectId || ''
                    });
                    
                    this.dragEvent = null;
                    this.saveToFile();
                },

                getEventStyle(evt) {
                    return `grid-column: ${evt.day + 2}; grid-row: ${evt.slotStart} / span ${evt.slotSpan};`;
                },

                // --- IMPACT LOGIC ---
                syncEventToProject(evt) {
                    if (!evt.linkedProjectId || !evt.impact) return;
                    const proj = this.projects.find(p => p.id == evt.linkedProjectId);
                    if (proj) {
                        if (!proj.updates) proj.updates = [];
                        proj.updates.push({
                            date: new Date().toISOString(),
                            text: evt.impact,
                            source: 'Calendar Sync'
                        });
                        this.showToast('Impact Logged to ' + proj.title);
                        this.saveToFile();
                    }
                },

                getLatestImpact(prioId) {
                    const pillarProjects = this.projects.filter(p => p.priorityId == prioId);
                    let allUpdates = [];
                    pillarProjects.forEach(p => { if(p.updates) allUpdates = [...allUpdates, ...p.updates]; });
                    if (allUpdates.length === 0) return 'No recent impact recorded.';
                    return allUpdates.sort((a,b) => new Date(b.date) - new Date(a.date))[0].text;
                },

                calculateProgress(p) {
                    if (!p.milestones || p.milestones.length === 0) return 0;
                    return Math.round((p.milestones.filter(m => m.completed).length / p.milestones.length) * 100);
                },

                calculatePriorityProgress(pId) {
                    const projs = this.projects.filter(p => p.priorityId == pId);
                    if (projs.length === 0) return 0;
                    const total = projs.reduce((acc, p) => acc + this.calculateProgress(p), 0);
                    return Math.round(total / projs.length);
                },

                // --- FILE ACCESS ---
                async openFile() {
                    try {
                        const [handle] = await window.showOpenFilePicker();
                        this.fileHandle = handle;
                        const file = await handle.getFile();
                        const data = JSON.parse(await file.text());
                        this.projects = data.projects || [];
                        this.todos = data.todos || [];
                        this.calendarEvents = data.calendarEvents || [];
                        this.showToast('Data Synced');
                    } catch (e) { console.error(e); }
                },

                async saveToFile() {
                    if (!this.fileHandle) return;
                    const writable = await this.fileHandle.createWritable();
                    await writable.write(JSON.stringify({
                        projects: this.projects,
                        todos: this.todos,
                        calendarEvents: this.calendarEvents,
                        settings: this.settings
                    }, null, 2));
                    await writable.close();
                },

                showToast(msg) { alert(msg); } // Placeholder for custom toast
            }
        }
    </script>
</body>
</html>
