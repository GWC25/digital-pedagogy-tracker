<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Impact Hub v7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col" x-data="appData()" x-init="init()">

    <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 w-10 h-10 rounded flex items-center justify-center font-bold text-xl">DC</div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Digital Impact Hub</h1>
                <p class="text-xs text-slate-400">Dashboard & Strategy Edition</p>
            </div>
        </div>
        
        <div class="flex items-center bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
            <template x-if="!fileHandle">
                <div class="flex items-center gap-2 text-amber-400 animate-pulse">
                    <i class="fas fa-exclamation-triangle"></i><span class="text-xs font-bold uppercase">Not Connected</span>
                </div>
            </template>
            <template x-if="fileHandle">
                <div class="flex items-center gap-2 text-emerald-400">
                    <i class="fas fa-link"></i><span class="text-xs font-bold uppercase">Live Linked</span>
                </div>
            </template>
        </div>

        <div>
             <template x-if="!fileHandle">
                <button @click="openFile()" class="text-sm bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold shadow transition">
                    <i class="fas fa-folder-open mr-2"></i> Connect Data
                </button>
             </template>
             <template x-if="fileHandle">
                <button @click="saveToFile()" class="text-sm bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded font-bold shadow transition">
                    <i class="fas fa-save mr-2"></i> Save Changes
                </button>
             </template>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 relative">
        
        <div x-show="!fileHandle" class="max-w-2xl mx-auto mt-20 text-center">
            <div class="bg-white p-10 rounded-xl shadow-xl border-2 border-slate-200">
                <div class="text-6xl text-slate-300 mb-6"><i class="fas fa-chart-line"></i></div>
                <h2 class="text-3xl font-bold text-slate-800 mb-4">Connect Data File</h2>
                <p class="text-slate-600 mb-8 leading-relaxed">
                    Connect to your <strong>digital-coach-data.json</strong> file.<br>
                    Restoring Visual Dashboard & Pipeline Charts.
                </p>
                <button @click="openFile()" class="bg-blue-600 text-white text-lg px-8 py-4 rounded shadow-lg hover:bg-blue-700 transition">
                    Select File from OneDrive
                </button>
            </div>
        </div>

        <div x-show="fileHandle" x-transition>
            
            <div class="flex justify-center gap-6 mb-8 border-b border-slate-200 pb-4 no-print">
                <button @click="switchView('dashboard')" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'dashboard'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600 transition">Dashboard</button>
                <button @click="switchView('strategy')" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'strategy'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600 transition"><i class="fas fa-chess mr-1"></i> Strategy Pillars</button>
                <button @click="switchView('projects')" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'projects'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600 transition">Projects</button>
                <button @click="switchView('reports')" :class="{'text-blue-600 border-b-2 border-blue-600': view === 'reports'}" class="pb-2 font-bold text-slate-500 hover:text-blue-600 transition">Reports</button>
            </div>

            <div x-show="view === 'dashboard'" class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                        <div class="text-xs font-bold text-slate-400 uppercase">Active Cases</div>
                        <div class="text-3xl font-bold" x-text="projects.filter(p=>p.status!=='Completed').length"></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-amber-500">
                        <div class="text-xs font-bold text-slate-400 uppercase">Deadlines (30 Days)</div>
                        <div class="text-3xl font-bold" x-text="getAllDueTasks().length"></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-emerald-500">
                        <div class="text-xs font-bold text-slate-400 uppercase">Completed</div>
                        <div class="text-3xl font-bold" x-text="projects.filter(p=>p.status==='Completed').length"></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-purple-500">
                        <div class="text-xs font-bold text-slate-400 uppercase">Evidence Links</div>
                        <div class="text-3xl font-bold" x-text="countEvidence()"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-6 rounded shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-4">Strategic Focus (Priority Split)</h3>
                        <div class="h-64"><canvas id="priorityChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded shadow-sm">
                        <h3 class="font-bold text-slate-700 mb-4">Coaching Pipeline Stage</h3>
                        <div class="h-64"><canvas id="pipelineChart"></canvas></div>
                    </div>
                </div>

                <div class="bg-white rounded p-6 shadow-sm">
                    <h3 class="font-bold text-lg mb-4 text-slate-800">Action Required: Next 30 Days</h3>
                    <div class="space-y-2 overflow-y-auto max-h-60 pr-2">
                            <template x-for="task in getAllDueTasks()" :key="task.id">
                            <div class="flex justify-between items-center p-3 border-l-4 rounded shadow-sm hover:shadow transition cursor-pointer bg-white border-gray-200"
                                 :class="task.isStrategy ? 'border-l-purple-500 bg-purple-50' : 'border-l-blue-500 hover:bg-blue-50'">
                                <div>
                                    <div class="text-sm font-bold text-slate-800" x-text="task.title"></div>
                                    <div class="text-xs text-slate-500">
                                        <span x-show="task.isStrategy" class="text-purple-700 font-bold uppercase text-[10px] mr-1">Strategy Action</span>
                                        <span x-text="task.context"></span>
                                    </div>
                                </div>
                                <div class="text-xs font-bold" :class="isOverdue(task.dueDate) ? 'text-red-600' : 'text-slate-600'" x-text="formatDate(task.dueDate)"></div>
                            </div>
                        </template>
                        <div x-show="getAllDueTasks().length === 0" class="text-slate-400 italic text-sm text-center py-4">No urgent tasks. Good job!</div>
                    </div>
                </div>
            </div>

            <div x-show="view === 'strategy'" class="max-w-6xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Strategic Pillars</h2>
                        <p class="text-slate-500 text-sm">Define Goals, High-Level Milestones, and Core Actions.</p>
                    </div>
                    <button @click="saveToFile()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"><i class="fas fa-save mr-2"></i> Save Strategy</button>
                </div>

                <div class="space-y-8">
                    <template x-for="(p, idx) in settings.priorities" :key="p.id">
                        <div class="bg-white rounded shadow-md border border-slate-200 overflow-hidden">
                            <div class="p-4 flex justify-between items-center" :class="getHeaderColor(idx)">
                                <h3 class="font-bold text-lg text-white" x-text="'Priority ' + (idx + 1)"></h3>
                                <div class="text-white text-sm opacity-90 font-mono">ID: <span x-text="p.id"></span></div>
                            </div>
                            
                            <div class="p-6">
                                <input x-model="p.title" class="w-full text-lg font-bold border-b-2 border-slate-200 focus:border-blue-500 outline-none mb-4 pb-1 transition" placeholder="Enter Priority Title...">
                                
                                <textarea x-model="p.details" class="w-full text-sm p-3 bg-slate-50 border rounded mb-6 h-20 focus:ring-2 focus:ring-blue-100 outline-none" placeholder="Strategy Description..."></textarea>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-purple-50 rounded p-4 border border-purple-100">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="font-bold text-sm text-purple-900 uppercase">Strategic Milestones (Phases)</h4>
                                            <button @click="addStratMilestone(p)" class="text-xs bg-white border px-2 py-1 rounded text-purple-700 hover:bg-purple-100"><i class="fas fa-plus"></i> Add</button>
                                        </div>
                                        <div class="space-y-2">
                                            <template x-for="(sm, smIdx) in p.strategicMilestones" :key="smIdx">
                                                <div class="bg-white p-2 rounded shadow-sm border border-purple-100">
                                                    <input x-model="sm.title" class="w-full text-sm font-bold border-b border-transparent focus:border-purple-300 outline-none mb-1" placeholder="Phase Name (e.g. Audit)">
                                                    <div class="flex justify-between items-center">
                                                        <input type="date" x-model="sm.targetDate" class="text-xs bg-transparent text-slate-500">
                                                        <select x-model="sm.status" class="text-[10px] border rounded bg-slate-50"><option>Planned</option><option>In Progress</option><option>Complete</option></select>
                                                        <button @click="p.strategicMilestones.splice(smIdx, 1)" class="text-slate-300 hover:text-red-400 ml-2"><i class="fas fa-times"></i></button>
                                                    </div>
                                                </div>
                                            </template>
                                            <div x-show="!p.strategicMilestones || p.strategicMilestones.length === 0" class="text-center text-xs text-purple-400 italic py-2">No phases defined.</div>
                                        </div>
                                    </div>

                                    <div class="bg-slate-50 rounded p-4 border border-slate-200">
                                        <div class="flex justify-between items-center mb-3">
                                            <h4 class="font-bold text-sm text-slate-700 uppercase">Core Strategic Actions</h4>
                                            <button @click="addStrategyTask(p)" class="text-xs bg-white border px-2 py-1 rounded text-slate-600 hover:bg-slate-100"><i class="fas fa-plus"></i> Add Action</button>
                                        </div>
                                        <div class="space-y-2">
                                            <template x-for="(task, tIdx) in p.tasks" :key="tIdx">
                                                <div class="flex flex-col gap-1 bg-white p-2 rounded shadow-sm border border-slate-100">
                                                    <div class="flex items-center gap-2">
                                                        <input type="checkbox" x-model="task.completed" class="w-4 h-4 text-blue-600 rounded cursor-pointer">
                                                        <input x-model="task.name" class="flex-1 text-sm bg-transparent border-none outline-none focus:text-blue-700 placeholder-slate-400" placeholder="Action Name...">
                                                        <button @click="p.tasks.splice(tIdx, 1)" class="text-slate-300 hover:text-red-400"><i class="fas fa-times"></i></button>
                                                    </div>
                                                    <div class="flex items-center gap-2 ml-6">
                                                        <span class="text-[10px] text-slate-400 uppercase font-bold">Deadline:</span>
                                                        <input type="date" x-model="task.dueDate" class="text-xs bg-transparent border-b border-slate-200 text-slate-600 focus:border-blue-300 outline-none">
                                                    </div>
                                                </div>
                                            </template>
                                            <div x-show="p.tasks.length === 0" class="text-center text-xs text-slate-400 italic py-2">No actions defined.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'projects'" class="max-w-7xl mx-auto">
                <div class="flex justify-between mb-6">
                    <div class="flex gap-2">
                        <input x-model="searchQuery" placeholder="Search projects..." class="border p-2 rounded w-64 text-sm">
                        <button @click="startNewProject()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 shadow"><i class="fas fa-plus mr-1"></i> New Project</button>
                    </div>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="project in filteredProjects" :key="project.id">
                        <div class="bg-white p-4 rounded shadow border hover:shadow-md transition cursor-pointer flex flex-col group" @click="editProject(project)">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-slate-800 truncate pr-2 group-hover:text-blue-600 transition" x-text="project.title"></h3>
                                <span class="text-[10px] bg-slate-100 px-2 py-1 rounded uppercase font-bold tracking-wide" x-text="project.type"></span>
                            </div>
                            <div x-show="getProjectStrategyName(project)" class="mb-3">
                                <span class="text-[10px] bg-blue-50 text-blue-700 border border-blue-100 px-2 py-1 rounded truncate block">
                                    <i class="fas fa-link mr-1"></i> <span x-text="getProjectStrategyName(project)"></span>
                                </span>
                            </div>
                            <p class="text-xs text-slate-500 mb-4 line-clamp-2" x-text="project.objective || 'No objective set.'"></p>
                            <div class="mt-auto">
                                <div class="w-full bg-slate-100 rounded-full h-1.5 mb-2">
                                    <div class="bg-blue-600 h-1.5 rounded-full" :style="`width: ${calculateProgress(project)}%`"></div>
                                </div>
                                <div class="flex justify-between text-xs text-slate-400">
                                    <span x-text="calculateProgress(project) + '% Complete'"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'reports'" class="max-w-5xl mx-auto">
                 <div class="bg-white p-6 rounded shadow mb-6 no-print">
                    <h2 class="font-bold text-lg mb-2">Strategy Report</h2>
                    <button @click="generateReport()" class="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700">Generate Full Report</button>
                </div>
                <div id="print-area" x-show="reportData.length > 0" class="bg-white p-10 shadow-lg min-h-screen">
                    <div class="border-b-2 border-black pb-4 mb-8 flex justify-between items-end">
                        <div>
                            <h1 class="text-3xl font-bold uppercase">Digital Strategy Status</h1>
                            <p class="text-slate-500">Digital Pedagogy Coach</p>
                        </div>
                        <div class="text-right text-sm">
                            <p class="font-bold">Weston College</p>
                            <p x-text="new Date().toLocaleDateString()"></p>
                        </div>
                    </div>

                    <template x-for="p in settings.priorities" :key="p.id">
                        <div class="mb-10 break-inside-avoid">
                            <h2 class="text-xl font-bold text-white px-4 py-2 rounded-t" :class="getHeaderColor(p.id - 1)" x-text="p.title"></h2>
                            <div class="border-l-2 border-r-2 border-b-2 border-slate-100 p-4 rounded-b">
                                <p class="text-sm text-slate-600 italic mb-4" x-text="p.details"></p>
                                
                                <div class="grid grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <h3 class="text-xs font-bold uppercase text-purple-800 mb-2 border-b border-purple-200 pb-1">Milestone Timeline</h3>
                                        <div class="space-y-2">
                                            <template x-for="sm in p.strategicMilestones">
                                                <div class="flex justify-between text-xs">
                                                    <span class="font-bold text-slate-700" x-text="sm.title"></span>
                                                    <span>
                                                        <span x-text="formatDate(sm.targetDate)" class="text-slate-500 mr-2"></span>
                                                        <span class="px-1 rounded bg-slate-100" x-text="sm.status"></span>
                                                    </span>
                                                </div>
                                            </template>
                                             <div x-show="!p.strategicMilestones || p.strategicMilestones.length === 0" class="text-xs text-slate-400">No milestones set.</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-xs font-bold uppercase text-blue-800 mb-2 border-b border-blue-200 pb-1">Core Actions</h3>
                                        <div class="space-y-1">
                                            <template x-for="t in p.tasks">
                                                <div class="flex justify-between text-xs">
                                                    <span :class="{'line-through text-slate-400': t.completed}" x-text="t.name"></span>
                                                    <span x-show="t.dueDate" class="text-slate-400" x-text="formatDate(t.dueDate)"></span>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>

                                <h3 class="text-xs font-bold uppercase text-slate-500 mb-2">Linked Evidence</h3>
                                <div class="space-y-2">
                                    <template x-for="proj in getProjectsForPriority(p.id)" :key="proj.id">
                                        <div class="bg-slate-50 p-2 rounded flex justify-between items-center">
                                            <div>
                                                <span class="font-bold text-sm" x-text="proj.title"></span>
                                                <span class="text-xs text-slate-500 ml-2" x-text="proj.objective"></span>
                                            </div>
                                            <div class="text-xs">
                                                <span x-text="calculateProgress(proj) + '%'"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

        </div> </main>

    <div x-show="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-cloak>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg">Manage Project</h3>
                <button @click="showModal = false"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <input x-model="currentProject.title" class="w-full border p-2 rounded font-bold" placeholder="Project Name">
                    <div class="bg-blue-50 p-3 rounded border border-blue-100">
                        <label class="block text-xs font-bold uppercase text-blue-800 mb-1">Strategic Alignment</label>
                        <select x-model="currentProject.priorityId" class="w-full border p-2 rounded text-sm mb-2">
                            <option value="">-- Select Core Priority --</option>
                            <template x-for="p in settings.priorities" :key="p.id"><option :value="p.id" x-text="p.title"></option></template>
                        </select>
                        <div x-show="currentProject.priorityId">
                            <label class="block text-xs font-bold uppercase text-blue-800 mb-1">Evidence For Action:</label>
                            <select x-model="currentProject.linkedTaskName" class="w-full border p-2 rounded text-sm bg-white">
                                <option value="">-- General --</option>
                                <template x-for="t in getTasksForCurrentPriority()" :key="t.name"><option :value="t.name" x-text="t.name"></option></template>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input x-model="currentProject.contact" class="border p-2 rounded text-sm" placeholder="Contact/Dept">
                        <select x-model="currentProject.type" class="border p-2 rounded text-sm"><option value="coaching">Coaching</option><option value="project">Project</option></select>
                    </div>
                    <textarea x-model="currentProject.objective" class="w-full border p-2 rounded h-20 text-sm" placeholder="Objective"></textarea>
                    <div class="border-t pt-2">
                         <input x-model="currentProject.formEmbedUrl" placeholder="Paste MS Forms Embed URL..." class="w-full border p-2 rounded text-xs">
                    </div>
                </div>
                <div class="border-l pl-6">
                    <div class="flex justify-between mb-2"><h4 class="font-bold text-sm uppercase text-slate-500">Milestones</h4><button @click="addMilestone()" class="text-xs bg-slate-200 px-2 py-1 rounded">Add</button></div>
                    <div class="space-y-2 max-h-[500px] overflow-y-auto">
                        <template x-for="(m, idx) in currentProject.milestones" :key="idx">
                            <div class="bg-slate-50 p-2 rounded border"><div class="flex gap-2 items-start"><input type="checkbox" x-model="m.completed" class="mt-1.5"><div class="flex-1 space-y-1"><input x-model="m.title" class="w-full bg-transparent border-b border-transparent focus:border-blue-300 outline-none text-sm font-semibold"><div class="flex gap-2 items-center"><input type="date" x-model="m.dueDate" class="text-xs bg-transparent w-24"><input x-model="m.evidenceLink" placeholder="Evidence Link..." class="text-xs w-full text-blue-600 bg-transparent"></div></div><button @click="currentProject.milestones.splice(idx, 1)" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button></div></div>
                        </template>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end gap-2"><button @click="showModal = false" class="px-4 py-2 text-slate-500">Cancel</button><button @click="saveProject()" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button></div>
        </div>
    </div>

    <script>
        function appData() {
            return {
                view: 'dashboard',
                fileHandle: null,
                showModal: false,
                searchQuery: '',
                projects: [],
                reportData: [],
                settings: { priorities: [
                    { id: 1, title: 'Teams Foundations & Accessibility', details: 'Teams Health Check, Accessibility Toolkit & Digital Champions.', tasks: [], strategicMilestones: [] },
                    { id: 2, title: 'AI & Assessment Efficiency', details: 'Co-Pilot Rollout, AI Strategy & Formative Assessment.', tasks: [], strategicMilestones: [] },
                    { id: 3, title: 'Modelling & TLA', details: 'Screen recording, Pedagogy First & Modelling best practice.', tasks: [], strategicMilestones: [] }
                ]},
                currentProject: {},
                charts: {}, // Stores Chart Instances

                async init() {},

                async openFile() {
                    try {
                        const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON Data', accept: { 'application/json': ['.json'] } }], multiple: false });
                        this.fileHandle = handle;
                        const file = await handle.getFile();
                        const text = await file.text();
                        if (text.trim()) {
                            const data = JSON.parse(text);
                            this.projects = data.projects || [];
                            if (data.settings && data.settings.priorities) {
                                this.settings.priorities = data.settings.priorities.map(p => ({
                                    ...p,
                                    strategicMilestones: p.strategicMilestones || []
                                }));
                            }
                            this.$nextTick(() => this.initCharts());
                        }
                    } catch (err) { console.error(err); }
                },

                async saveToFile() {
                    if (!this.fileHandle) return;
                    try {
                        const writable = await this.fileHandle.createWritable();
                        await writable.write(JSON.stringify({ projects: this.projects, settings: this.settings }, null, 2));
                        await writable.close();
                        this.updateCharts();
                        const btn = document.querySelector('.fa-save');
                        if(btn) { btn.parentElement.classList.add('bg-green-700'); setTimeout(()=>btn.parentElement.classList.remove('bg-green-700'), 500); }
                    } catch (err) { alert('Save failed: ' + err.message); }
                },

                // --- CHARTS (RESTORED FROM V4) ---
                initCharts() {
                    // Priority Chart (Doughnut)
                    const pCtx = document.getElementById('priorityChart').getContext('2d');
                    this.charts.priority = new Chart(pCtx, {
                        type: 'doughnut',
                        data: this.getPriorityData(),
                        options: { responsive: true, maintainAspectRatio: false }
                    });

                    // Pipeline Chart (Bar)
                    const pipeCtx = document.getElementById('pipelineChart').getContext('2d');
                    this.charts.pipeline = new Chart(pipeCtx, {
                        type: 'bar',
                        data: this.getPipelineData(),
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                        }
                    });
                },

                updateCharts() {
                    if(this.charts.priority) { this.charts.priority.data = this.getPriorityData(); this.charts.priority.update(); }
                    if(this.charts.pipeline) { this.charts.pipeline.data = this.getPipelineData(); this.charts.pipeline.update(); }
                },

                getPriorityData() {
                    const counts = this.settings.priorities.map(p => this.projects.filter(proj => proj.priorityId == p.id).length);
                    return {
                        labels: this.settings.priorities.map(p => p.title.substring(0, 15)+'...'),
                        datasets: [{ data: counts, backgroundColor: ['#2563eb', '#f59e0b', '#059669'], borderWidth: 0 }]
                    };
                },

                getPipelineData() {
                    // Count by Status
                    const active = this.projects.filter(p => p.status !== 'Completed').length;
                    const completed = this.projects.filter(p => p.status === 'Completed').length;
                    return {
                        labels: ['Active Cases', 'Completed Cases'],
                        datasets: [{ label: 'Projects', data: [active, completed], backgroundColor: ['#3b82f6', '#10b981'] }]
                    };
                },

                // --- HELPERS ---
                addStrategyTask(priority) { if (!priority.tasks) priority.tasks = []; priority.tasks.push({ name: 'New Action', completed: false, dueDate: '' }); },
                addStratMilestone(priority) { if(!priority.strategicMilestones) priority.strategicMilestones = []; priority.strategicMilestones.push({ title: 'New Phase', targetDate: '', status: 'Planned' }); },
                
                getAllDueTasks() {
                    let all = [];
                    // Project tasks
                    this.projects.forEach(p => {
                        (p.milestones||[]).forEach(m => {
                            if (!m.completed && m.dueDate) all.push({id:Math.random(), projectId:p.id, projectName:p.title, title:m.title, dueDate:m.dueDate, context:'Project Task', isStrategy: false});
                        });
                    });
                    // Strategy tasks
                    this.settings.priorities.forEach(p => {
                        (p.tasks||[]).forEach(t => {
                            if (!t.completed && t.dueDate) all.push({id:Math.random(), projectId:null, projectName:p.title, title:t.name, dueDate:t.dueDate, context:'Core Action', isStrategy: true});
                        });
                    });
                    return all.sort((a,b)=>a.dueDate.localeCompare(b.dueDate)).slice(0, 30);
                },

                isOverdue(dateStr) { return new Date(dateStr) < new Date(new Date().setHours(0,0,0,0)); },
                countEvidence() { return this.projects.reduce((acc, p) => acc + (p.milestones||[]).filter(m => m.evidenceLink).length, 0); },
                
                getTasksForCurrentPriority() { const p = this.settings.priorities.find(x => x.id == this.currentProject.priorityId); return p ? p.tasks : []; },
                getProjectStrategyName(p) { if (!p.priorityId) return null; const prio = this.settings.priorities.find(x => x.id == p.priorityId); if (!prio) return null; return p.linkedTaskName ? p.linkedTaskName : prio.title; },

                // --- UI ---
                getHeaderColor(idx) { return ['bg-blue-600', 'bg-amber-500', 'bg-emerald-600'][idx % 3]; },
                formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB') : ''; },

                switchView(v) { this.view = v; if(v==='dashboard') setTimeout(()=>this.updateCharts(),100); },
                startNewProject() { this.currentProject = { id: Date.now(), title: '', priorityId: '', linkedTaskName: '', type: 'coaching', milestones: [], status: 'Active' }; this.showModal = true; },
                editProject(p) { this.currentProject = JSON.parse(JSON.stringify(p)); this.showModal = true; },
                saveProject() { 
                    const idx = this.projects.findIndex(x => x.id === this.currentProject.id);
                    if(idx === -1) this.projects.push(this.currentProject); else this.projects[idx] = this.currentProject;
                    this.saveToFile(); this.showModal = false; 
                },
                addMilestone() { if(!this.currentProject.milestones) this.currentProject.milestones=[]; this.currentProject.milestones.push({title:'New Task', completed:false}); },
                get filteredProjects() { return this.projects.filter(p => p.title.toLowerCase().includes(this.searchQuery.toLowerCase())); },
                calculateProgress(p) { return !p.milestones?.length ? 0 : Math.round((p.milestones.filter(m=>m.completed).length / p.milestones.length)*100); },
                
                generateReport() { this.reportData = this.settings.priorities; setTimeout(() => document.getElementById('print-area').scrollIntoView({behavior:'smooth'}), 100); },
            }
        }
    </script>
</body>
</html>
