<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Impact Hub v28.0 (Professional Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            .break-avoid { break-inside: avoid; }
        }
        /* Professional Scrollbars */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Slide-Over Animation */
        .slide-over-enter-active, .slide-over-leave-active { transition: transform 0.3s ease-in-out; }
        .slide-over-enter-start, .slide-over-leave-end { transform: translateX(100%); }
        
        /* Gantt Grid */
        .gantt-container { overflow-x: auto; padding-bottom: 10px; }
        .gantt-grid { display: grid; gap: 0; } 
        .gantt-row { display: contents; } 
        .gantt-header { font-size: 0.70rem; font-weight: bold; text-align: center; padding: 6px 2px; background: #f8fafc; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.1; height: 100%; color: #64748b; }
        .gantt-cell { background: #fff; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; height: 44px; }
        .gantt-sticky-col { position: sticky; left: 0; z-index: 20; background: white; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; height: 44px; display: flex; align-items: center; }
        
        /* Toast Notifications */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; border-left: 4px solid #2563eb; padding: 12px 20px; border-radius: 4px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: translateX(100%); transition: transform 0.3s ease-out; display: flex; align-items: center; gap: 10px; min-width: 250px; }
        .toast.show { transform: translateX(0); }
        
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden" x-data="appData()" x-init="init()">

    <header class="bg-white border-b border-slate-200 h-16 flex justify-between items-center px-6 shadow-sm z-30 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-slate-900 text-white w-8 h-8 rounded flex items-center justify-center font-bold text-sm">DC</div>
            <div>
                <h1 class="font-bold text-slate-800 leading-none">Digital Impact Hub</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-wide mt-0.5">Professional Edition v28.0</p>
            </div>
        </div>
        
        <nav class="hidden md:flex gap-1" x-show="fileHandle">
            <template x-for="item in navItems">
                <button @click="switchView(item.id)" 
                        :class="view === item.id ? 'bg-slate-100 text-blue-700 font-bold' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'"
                        class="px-4 py-2 rounded text-sm transition flex items-center gap-2">
                    <i :class="item.icon"></i> <span x-text="item.label"></span>
                </button>
            </template>
        </nav>

        <div class="flex items-center gap-3">
            <template x-if="!fileHandle">
                <button @click="openFile()" class="text-xs bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded font-bold shadow transition flex items-center gap-2 animate-pulse">
                    <i class="fas fa-plug"></i> Connect Data
                </button>
            </template>
            <template x-if="fileHandle">
                <div class="flex items-center gap-3">
                    <span class="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-1 rounded border border-emerald-100 font-bold flex items-center gap-1"><i class="fas fa-circle text-[6px]"></i> LIVE</span>
                    <button @click="saveToFile()" class="text-xs bg-white border border-slate-300 text-slate-600 hover:bg-slate-50 px-3 py-2 rounded font-bold transition">
                        <i class="fas fa-save mr-1"></i> Save
                    </button>
                </div>
            </template>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto relative bg-slate-50/50">
        
        <div x-show="!fileHandle" class="h-full flex flex-col items-center justify-center p-6">
            <div class="bg-white p-12 rounded-2xl shadow-xl border border-slate-200 text-center max-w-lg">
                <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl"><i class="fas fa-cloud-upload-alt"></i></div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome Back</h2>
                <p class="text-slate-500 mb-8 text-sm leading-relaxed">Connect to your <strong>digital-coach-data.json</strong> file to load your dashboard, strategy, and meeting notes.</p>
                <button @click="openFile()" class="bg-slate-900 text-white text-sm font-bold px-8 py-3 rounded-lg hover:bg-slate-800 transition w-full">Select Local File</button>
            </div>
        </div>

        <div x-show="fileHandle" x-transition class="h-full flex flex-col p-6">
            
            <div x-show="view === 'dashboard'" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 w-full animate-fade-in">
                 <div class="lg:col-span-2 space-y-6">
                    <div class="flex justify-between items-center bg-white p-2 rounded-lg shadow-sm border border-slate-200">
                        <div class="text-xs font-bold text-slate-400 uppercase px-3 tracking-wider">Dashboard Context</div>
                        <div class="flex bg-slate-100 rounded p-1">
                            <button @click="dashboardMode='strategy'; updateCharts()" :class="dashboardMode==='strategy'?'bg-white text-blue-600 shadow-sm':'text-slate-500'" class="px-4 py-1.5 rounded text-xs font-bold transition">Strategy Focus</button>
                            <button @click="dashboardMode='governance'; updateCharts()" :class="dashboardMode==='governance'?'bg-white text-purple-600 shadow-sm':'text-slate-500'" class="px-4 py-1.5 rounded text-xs font-bold transition">Governance Focus</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Active Projects</span>
                            <span class="text-3xl font-bold text-slate-800" x-text="projects.filter(p=>p.status!=='Completed').length"></span>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Actions Due</span>
                            <span class="text-3xl font-bold text-amber-500" x-text="getAllDueTasks().length"></span>
                        </div>
                        <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 flex flex-col">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">QIP Traction</span>
                            <span class="text-3xl font-bold text-purple-600" x-text="projects.filter(p => p.isQip).length"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 h-64">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition group" @click="switchView('projects')">
                            <div class="flex justify-between mb-2"><h3 class="font-bold text-slate-700 text-xs uppercase" x-text="dashboardMode==='strategy' ? 'Strategic Focus' : 'KPI Alignment'"></h3><i class="fas fa-arrow-right text-slate-300 group-hover:text-blue-500 text-xs"></i></div>
                            <div class="h-48"><canvas id="priorityChart"></canvas></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 cursor-pointer hover:shadow-md transition group" @click="switchView('projects')">
                            <div class="flex justify-between mb-2"><h3 class="font-bold text-slate-700 text-xs uppercase">Pipeline Health</h3><i class="fas fa-arrow-right text-slate-300 group-hover:text-blue-500 text-xs"></i></div>
                            <div class="h-48"><canvas id="pipelineChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-sm text-slate-800 uppercase tracking-wider"><i class="fas fa-bolt text-yellow-500 mr-2"></i>Today's Focus</h3>
                        <span class="text-[10px] font-mono text-slate-400" x-text="new Date().toLocaleDateString()"></span>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto">
                        <div class="flex gap-2 mb-4">
                            <input x-model="newTodo" @keydown.enter="addTodo()" placeholder="Add a quick task..." class="flex-1 border border-slate-300 p-2 rounded text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none">
                            <button @click="addTodo()" class="bg-slate-800 text-white px-3 rounded hover:bg-slate-700 transition"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(todo, idx) in todos" :key="idx">
                                <div class="flex items-start gap-3 p-3 rounded border border-slate-100 transition group hover:border-blue-200" :class="todo.completed ? 'bg-slate-50 opacity-60' : 'bg-white shadow-sm'">
                                    <input type="checkbox" x-model="todo.completed" @change="syncFromDashboard(todo)" class="mt-1 w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
                                    <div class="flex-1">
                                        <div class="text-sm font-medium text-slate-700" :class="{'line-through text-slate-400': todo.completed}" x-text="todo.text"></div>
                                        <div x-show="todo.projectTitle" class="text-[10px] text-blue-500 font-medium mt-0.5" x-text="todo.projectTitle"></div>
                                    </div>
                                    <button @click="deleteTodo(idx)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button>
                                </div>
                            </template>
                            <div x-show="todos.length === 0" class="text-center py-10">
                                <div class="text-slate-300 text-4xl mb-2"><i class="fas fa-check-circle"></i></div>
                                <p class="text-slate-400 text-xs">All caught up!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="view === 'strategy'" class="max-w-6xl mx-auto w-full">
                <div class="flex flex-wrap gap-1 mb-6 border-b border-slate-200 pb-1">
                    <template x-for="(p, idx) in settings.priorities" :key="idx">
                        <button @click="activeStrategyTab = idx" class="px-4 py-2 rounded-t-lg font-bold text-sm transition border-t-2" :class="activeStrategyTab === idx ? 'bg-white text-blue-700 border-blue-600 shadow-sm' : 'bg-transparent text-slate-500 border-transparent hover:text-slate-700'"><span x-text="'P' + (idx + 1) + ': ' + (p.title || 'Untitled')"></span></button>
                    </template>
                    <button @click="addPriority()" class="px-3 py-2 text-slate-400 hover:text-blue-600"><i class="fas fa-plus"></i></button>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-8 min-h-[600px]">
                    <template x-if="settings.priorities[activeStrategyTab]">
                        <div>
                            <input x-model="settings.priorities[activeStrategyTab].title" class="w-full text-2xl font-bold text-slate-800 border-none outline-none placeholder-slate-300 mb-4" placeholder="Priority Title">
                            <textarea x-model="settings.priorities[activeStrategyTab].details" class="w-full text-sm text-slate-600 p-4 bg-slate-50 rounded border border-slate-200 mb-8 h-24 outline-none focus:ring-1 focus:ring-blue-200" placeholder="Strategic Intent..."></textarea>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div>
                                    <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h4 class="font-bold text-sm text-slate-800 uppercase tracking-wide">Strategic Milestones</h4><button @click="addStratMilestone(settings.priorities[activeStrategyTab])" class="text-xs text-blue-600 font-bold hover:underline">+ Add Milestone</button></div>
                                    <div class="space-y-4">
                                        <template x-for="(sm, smIdx) in settings.priorities[activeStrategyTab].strategicMilestones" :key="smIdx">
                                            <div class="bg-white border border-slate-200 rounded-lg p-4 shadow-sm relative group hover:border-blue-300 transition">
                                                <button @click="settings.priorities[activeStrategyTab].strategicMilestones.splice(smIdx, 1)" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-times"></i></button>
                                                <input x-model="sm.title" class="font-bold text-sm text-slate-800 w-full outline-none mb-1" placeholder="Milestone Title">
                                                <div class="flex justify-between items-center text-xs text-slate-500 mb-3">
                                                    <input type="date" x-model="sm.targetDate" class="bg-transparent border-none p-0 text-slate-400 hover:text-blue-600">
                                                    <span x-text="calculateMilestoneProgress(settings.priorities[activeStrategyTab].id, sm.title) + '% Complete'" class="font-bold text-blue-600"></span>
                                                </div>
                                                <div class="bg-slate-50 rounded p-2 border border-slate-100">
                                                    <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Aligned Projects</div>
                                                    <div class="space-y-1">
                                                        <template x-for="proj in getProjectsForMilestone(settings.priorities[activeStrategyTab].id, sm.title)">
                                                            <div class="text-xs flex justify-between cursor-pointer hover:text-blue-600" @click="editProject(proj)">
                                                                <span x-text="proj.title" class="truncate"></span>
                                                                <i class="fas fa-chevron-right text-[8px] mt-1"></i>
                                                            </div>
                                                        </template>
                                                        <button @click="createProjectFromAction(settings.priorities[activeStrategyTab], sm)" class="text-[10px] text-blue-500 font-bold mt-2 hover:underline">+ Launch Project</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h4 class="font-bold text-sm text-slate-800 uppercase tracking-wide">General Actions</h4><button @click="addStrategyTask(settings.priorities[activeStrategyTab])" class="text-xs text-blue-600 font-bold hover:underline">+ Add Task</button></div>
                                    <div class="bg-slate-50 rounded-lg border border-slate-200 p-4 space-y-2">
                                        <template x-for="(task, tIdx) in settings.priorities[activeStrategyTab].tasks" :key="tIdx">
                                            <div class="flex items-center gap-2 bg-white p-2 rounded border border-slate-100 shadow-sm">
                                                <input type="checkbox" x-model="task.completed" class="rounded text-blue-600">
                                                <input x-model="task.name" class="flex-1 text-xs bg-transparent border-none outline-none">
                                                <button @click="settings.priorities[activeStrategyTab].tasks.splice(tIdx, 1)" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'projects'" class="max-w-7xl mx-auto w-full">
                <div class="flex flex-col md:flex-row justify-between mb-6 gap-4 bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                    <div class="flex gap-2 items-center flex-wrap flex-1">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                            <input x-model="searchQuery" placeholder="Search projects..." class="pl-8 border border-slate-300 p-2 rounded text-sm w-48 focus:border-blue-500 outline-none">
                        </div>
                        <select x-model="filterPriority" class="border border-slate-300 p-2 rounded text-sm bg-white outline-none"><option value="">All Priorities</option><template x-for="p in settings.priorities" :key="p.id"><option :value="p.id" x-text="p.title"></option></template><option value="standalone">Stand-alone</option></select>
                        <select x-model="filterKpi" class="border border-slate-300 p-2 rounded text-sm bg-white outline-none text-purple-700 font-medium"><option value="">All KPIs</option><template x-for="k in settings.kpis"><option :value="k" x-text="k"></option></template></select>
                        <button x-show="searchQuery||filterPriority||filterKpi" @click="resetFilters()" class="text-xs text-red-500 hover:underline ml-2">Clear</button>
                    </div>
                    <button @click="startNewProject()" class="bg-blue-600 text-white px-5 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow-sm transition"><i class="fas fa-plus mr-2"></i> New Project</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="project in filteredProjects" :key="project.id">
                        <div class="bg-white rounded-lg shadow-sm border border-slate-200 transition hover:shadow-md flex flex-col h-full cursor-pointer group relative overflow-hidden" @click="editProject(project)">
                            <div class="absolute left-0 top-0 bottom-0 w-1" :class="getRagColor(project.endDate)"></div>
                            <div class="p-5 pl-6 flex-1 flex flex-col">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400" x-text="project.type"></span>
                                    <span x-show="project.kpi" class="text-[9px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded border border-purple-100 font-bold truncate max-w-[100px]" x-text="project.kpi"></span>
                                </div>
                                <h3 class="font-bold text-slate-800 text-lg leading-tight mb-2 group-hover:text-blue-600 transition" x-text="project.title"></h3>
                                <p class="text-xs text-slate-500 line-clamp-2 mb-4" x-text="project.objective || 'No objective set.'"></p>
                                
                                <div class="mt-auto">
                                    <div class="flex gap-2 mb-3">
                                        <span x-show="project.deptCode" class="text-[10px] bg-slate-100 text-slate-600 px-2 py-1 rounded font-medium" x-text="project.deptCode"></span>
                                        <span x-show="project.staff" class="text-[10px] bg-yellow-50 text-yellow-700 px-2 py-1 rounded font-medium border border-yellow-100" x-text="project.staff"></span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs font-bold text-slate-600">
                                        <div class="flex-1 bg-slate-100 rounded-full h-1.5 overflow-hidden">
                                            <div class="h-full bg-blue-500 rounded-full" :style="`width: ${calculateProgress(project)}%`"></div>
                                        </div>
                                        <span x-text="calculateProgress(project) + '%'"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'meetings'" class="max-w-7xl mx-auto w-full h-full flex bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="w-64 bg-slate-50 border-r border-slate-200 flex flex-col">
                    <div class="p-4 border-b border-slate-200"><h3 class="font-bold text-slate-700 uppercase text-xs tracking-wider">Notebooks</h3></div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-1">
                        <template x-for="cat in settings.meetingCategories" :key="cat">
                            <button @click="activeMeetingCategory = cat; currentMeeting = null" class="w-full text-left px-3 py-2.5 rounded-md text-sm font-medium transition flex justify-between items-center group" :class="activeMeetingCategory === cat ? 'bg-white shadow-sm text-blue-700' : 'text-slate-600 hover:bg-slate-100'">
                                <span class="truncate" x-text="cat"></span>
                                <span class="text-[10px] bg-slate-200 text-slate-500 px-1.5 py-0.5 rounded-full group-hover:bg-slate-300" x-text="meetingNotes.filter(n => n.category === cat).length"></span>
                            </button>
                        </template>
                    </div>
                    <button @click="addNewMeetingCategory()" class="m-2 p-2 text-xs text-blue-600 font-bold border border-dashed border-blue-200 rounded hover:bg-blue-50">+ Add Notebook</button>
                </div>
                <div class="w-80 border-r border-slate-200 flex flex-col bg-white">
                    <div class="p-3 border-b flex justify-between items-center bg-slate-50/50 h-14">
                        <span class="font-bold text-sm text-slate-700 truncate w-32" x-text="activeMeetingCategory"></span>
                        <button @click="createNewMeeting()" class="bg-slate-800 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-slate-700"><i class="fas fa-plus mr-1"></i> New</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50/30">
                        <template x-for="note in filteredMeetings" :key="note.id">
                            <div @click="currentMeeting = note" class="p-3 rounded-lg border cursor-pointer transition hover:shadow-md bg-white" :class="currentMeeting && currentMeeting.id === note.id ? 'border-blue-500 ring-1 ring-blue-500' : 'border-slate-200 hover:border-blue-300'">
                                <div class="font-bold text-sm text-slate-800 truncate" x-text="note.title || 'Untitled Note'"></div>
                                <div class="text-[10px] text-slate-400 mt-1" x-text="formatDate(note.date)"></div>
                                <div class="text-xs text-slate-500 mt-2 line-clamp-2" x-text="note.content || 'No content...'"></div>
                            </div>
                        </template>
                    </div>
                </div>
                <div class="flex-1 flex flex-col bg-white relative">
                    <template x-if="!currentMeeting">
                        <div class="flex items-center justify-center h-full text-slate-300 flex-col"><i class="far fa-file-alt text-5xl mb-4 text-slate-200"></i><p>Select a note to view or edit</p></div>
                    </template>
                    <template x-if="currentMeeting">
                        <div class="flex flex-col h-full">
                            <div class="p-6 border-b border-slate-100">
                                <input x-model="currentMeeting.title" class="text-2xl font-bold text-slate-800 w-full outline-none placeholder-slate-300" placeholder="Meeting Subject">
                                <div class="flex gap-6 mt-4 text-sm text-slate-500">
                                    <div class="flex items-center gap-2"><i class="far fa-calendar"></i><input type="date" x-model="currentMeeting.date" class="outline-none bg-transparent"></div>
                                    <div class="flex items-center gap-2 flex-1"><i class="far fa-user"></i><input x-model="currentMeeting.attendees" class="w-full outline-none bg-transparent" placeholder="Attendees..."></div>
                                </div>
                                <div class="mt-4 flex justify-between items-center">
                                    <select x-model="currentMeeting.linkedProjectId" class="text-xs border border-slate-200 rounded p-1.5 bg-slate-50 text-slate-600 outline-none"><option value="">Link to Project (Optional)</option><template x-for="p in projects" :key="p.id"><option :value="p.id" x-text="p.title"></option></template></select>
                                    <div class="flex gap-2">
                                        <button @click="deleteMeeting()" class="text-xs text-red-400 hover:text-red-600 px-2 font-bold">Delete</button>
                                        <button @click="saveToFile(); showToast('Note Saved')" class="text-xs bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700 font-bold shadow-sm">Save</button>
                                    </div>
                                </div>
                            </div>
                            <textarea x-model="currentMeeting.content" class="flex-1 w-full p-8 outline-none resize-none text-slate-700 leading-relaxed text-sm" placeholder="Start typing notes..."></textarea>
                            <div class="p-3 bg-slate-50 border-t border-slate-200 flex gap-2 items-center">
                                <span class="text-xs font-bold text-slate-400 uppercase">Quick Action:</span>
                                <input x-model="quickActionText" class="flex-1 border border-slate-300 rounded px-2 py-1 text-sm outline-none focus:border-blue-500" placeholder="Type a task to send to dashboard...">
                                <button @click="pushActionToDashboard()" class="bg-blue-600 text-white px-4 py-1 rounded text-xs font-bold hover:bg-blue-700">Add Task</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'gantt'" class="max-w-full mx-auto w-full">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-4 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <h2 class="font-bold text-slate-700">Timeline</h2>
                        <div class="flex bg-slate-100 rounded p-1">
                            <button @click="timelineMode = 'year'" :class="timelineMode==='year' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 rounded text-xs font-bold transition">Year</button>
                            <button @click="timelineMode = '3m'" :class="timelineMode==='3m' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 rounded text-xs font-bold transition">Quarter</button>
                            <button @click="timelineMode = '1m'" :class="timelineMode==='1m' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 rounded text-xs font-bold transition">Month</button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="timelineTab = 'all'" class="text-xs font-bold px-2 py-1 rounded" :class="timelineTab==='all'?'bg-blue-100 text-blue-700':'text-slate-500'">All</button>
                        <button @click="timelineTab = 'standalone'" class="text-xs font-bold px-2 py-1 rounded" :class="timelineTab==='standalone'?'bg-blue-100 text-blue-700':'text-slate-500'">Stand-alone</button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                    <div class="gantt-container">
                        <div class="gantt-grid text-xs" :style="getTimelineGridStyle()">
                            <div class="gantt-row font-bold text-slate-700 bg-slate-50 border-b border-slate-300 sticky top-0 z-20">
                                <div class="gantt-sticky-col px-4 border-b border-slate-300 bg-slate-50">Project</div>
                                <template x-for="(col, idx) in timelineColumns" :key="idx"><div class="gantt-header"><div x-text="col.label"></div><div x-show="col.sub" class="text-[9px] text-slate-400 font-normal" x-text="col.sub"></div></div></template>
                            </div>
                            <template x-for="(p, idx) in timelineProjects" :key="p.id">
                                <div class="gantt-row hover:bg-slate-50 transition group border-b border-slate-100">
                                    <div class="gantt-sticky-col px-4 text-xs font-bold truncate pr-4 cursor-pointer hover:text-blue-600 group-hover:bg-slate-50 text-slate-700" :style="`grid-row: ${idx + 2}; grid-column: 1`" @click="editProject(p)"><span x-text="p.title"></span></div>
                                    <template x-for="c in timelineColumns"><div class="gantt-cell group-hover:bg-slate-50" :style="`grid-row: ${idx + 2}`"></div></template>
                                    <div x-show="hasDates(p) && isProjectVisibleInTimeline(p)" class="rounded-full text-[9px] text-white flex items-center px-3 shadow-sm cursor-pointer hover:opacity-90 overflow-hidden z-10 h-6" :class="getPriorityColor(p.priorityId)" :style="getDynamicGanttBarStyle(p, idx)" @click="editProject(p)"><span class="truncate font-medium" x-text="formatDateShort(p.startDate) + ' - ' + formatDateShort(p.endDate)"></span></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="view === 'reports'" class="max-w-6xl mx-auto w-full h-full flex flex-col">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6 flex justify-between items-center no-print">
                    <h2 class="font-bold text-xl text-slate-800">Impact Reports</h2>
                    <div class="flex gap-2">
                        <select x-model="reportTab" class="border border-slate-300 rounded p-2 text-sm outline-none">
                            <option value="overview">Overview</option>
                            <option value="deepdive">Deep Dive Tool</option>
                            <option value="kpis">Governance (KPIs)</option>
                            <option value="standalone">Stand-alone Projects</option>
                        </select>
                        <button @click="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded font-bold text-sm shadow hover:bg-slate-700">Print</button>
                    </div>
                </div>
                
                <div x-show="reportTab === 'deepdive'" class="bg-white p-8 rounded-lg shadow-sm border border-slate-200 min-h-[500px]">
                    <h3 class="text-lg font-bold text-emerald-800 mb-6 border-b pb-2 border-emerald-100">Deep Dive Analysis</h3>
                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Filter Dimension</label><select x-model="reportDrillDownCategory" class="w-full border p-2 rounded text-sm bg-slate-50" @change="reportDrillDownValue=''"><option value="">Select...</option><option value="deptCode">Department</option><option value="tlam">TLAM</option><option value="staff">Staff Member</option><option value="kpi">KPI</option></select></div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Specific Value</label><select x-model="reportDrillDownValue" class="w-full border p-2 rounded text-sm bg-slate-50" :disabled="!reportDrillDownCategory"><option value="">Select...</option><template x-for="opt in getDrillDownOptions()" :key="opt"><option :value="opt" x-text="opt"></option></template></select></div>
                    </div>
                    <div x-show="reportDrillDownValue" class="space-y-4">
                        <template x-for="proj in getDrillDownResults()" :key="proj.id">
                            <div class="border border-slate-200 rounded p-4 flex justify-between items-center hover:bg-slate-50">
                                <div><div class="font-bold text-slate-800" x-text="proj.title"></div><div class="text-xs text-slate-500" x-text="proj.objective"></div></div>
                                <div class="font-bold text-emerald-600 text-lg" x-text="calculateProgress(proj) + '%'"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

        </div> 
    </main>

    <div x-show="showModal" class="fixed inset-0 z-50 overflow-hidden" x-cloak>
        <div class="absolute inset-0 bg-slate-900/20 backdrop-blur-sm transition-opacity" @click="showModal = false"></div>
        <div class="absolute inset-y-0 right-0 max-w-2xl w-full flex">
            <div class="h-full w-full bg-white shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col" 
                 x-transition:enter="translate-x-full" x-transition:enter-end="translate-x-0"
                 x-transition:leave="translate-x-0" x-transition:leave-end="translate-x-full">
                
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white z-10">
                    <h2 class="text-lg font-bold text-slate-800">Project Details</h2>
                    <div class="flex gap-2">
                        <button @click="showModal = false" class="text-slate-400 hover:text-slate-600 px-3 py-1">Cancel</button>
                        <button @click="saveProject(); showToast('Project Saved')" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm font-bold shadow hover:bg-blue-700">Save Changes</button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-8 bg-slate-50">
                    <input x-model="currentProject.title" class="w-full text-2xl font-bold bg-transparent border-none outline-none placeholder-slate-400 mb-6 text-slate-800" placeholder="Project Title">
                    
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6 space-y-4">
                        <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wide border-b pb-2">Core Metadata</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Priority</label><select x-model="currentProject.priorityId" class="w-full mt-1 border rounded p-2 text-sm bg-slate-50"><option value="">Stand-alone</option><template x-for="p in settings.priorities" :key="p.id"><option :value="p.id" x-text="p.title"></option></template></select></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Type</label><select x-model="currentProject.type" class="w-full mt-1 border rounded p-2 text-sm bg-slate-50"><option value="coaching">Coaching</option><option value="project">Project</option><option value="strategy">Strategy</option></select></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Department</label><input x-model="currentProject.deptCode" list="deptCodes" class="w-full mt-1 border rounded p-2 text-sm bg-slate-50"><datalist id="deptCodes"><option value="AGF"><option value="HAC"><option value="MAT"><option value="ENG"></datalist></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">Lead Staff</label><input x-model="currentProject.staff" class="w-full mt-1 border rounded p-2 text-sm bg-slate-50"></div>
                        </div>
                        <div><label class="text-[10px] text-slate-500 font-bold uppercase">Date Range</label><div class="flex gap-2 mt-1"><input type="date" x-model="currentProject.startDate" class="border rounded p-2 text-sm w-1/2 bg-slate-50"><input type="date" x-model="currentProject.endDate" class="border rounded p-2 text-sm w-1/2 bg-slate-50"></div></div>
                    </div>

                    <div class="bg-purple-50 p-6 rounded-lg border border-purple-100 mb-6">
                        <h4 class="text-xs font-bold text-purple-800 uppercase tracking-wide border-b border-purple-200 pb-2 mb-4">Governance & Quality</h4>
                        <div class="space-y-3">
                            <select x-model="currentProject.kpi" class="w-full border-none rounded p-2 text-sm bg-white shadow-sm"><option value="">Select KPI...</option><template x-for="k in settings.kpis"><option :value="k" x-text="k"></option></template></select>
                            <select x-model="currentProject.qaLink" class="w-full border-none rounded p-2 text-sm bg-white shadow-sm"><option value="">Select QA Mechanism...</option><template x-for="q in settings.qaSources"><option :value="q" x-text="q"></option></template></select>
                            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" x-model="currentProject.isQip" class="w-4 h-4 text-purple-600 rounded"><span class="text-sm font-bold text-purple-900">Linked to Dept QIP</span></label>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                        <div class="flex border-b border-slate-100">
                            <button @click="modalTab='tasks'" :class="modalTab==='tasks'?'bg-slate-50 text-blue-600 font-bold border-b-2 border-blue-600':'text-slate-500'" class="flex-1 py-3 text-sm transition">Micro-Tasks</button>
                            <button @click="modalTab='updates'" :class="modalTab==='updates'?'bg-slate-50 text-blue-600 font-bold border-b-2 border-blue-600':'text-slate-500'" class="flex-1 py-3 text-sm transition">Evidence Locker</button>
                        </div>
                        <div class="p-6 min-h-[300px]">
                            <div x-show="modalTab==='tasks'">
                                <div class="space-y-2 mb-4">
                                    <template x-for="(m, idx) in currentProject.milestones" :key="idx">
                                        <div class="flex items-center gap-2 p-2 rounded border border-slate-100 hover:bg-slate-50">
                                            <input type="checkbox" x-model="m.completed" class="w-4 h-4 text-green-500 rounded">
                                            <input x-model="m.title" class="flex-1 bg-transparent border-none outline-none text-sm text-slate-700">
                                            <button @click="currentProject.milestones.splice(idx, 1)" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                                        </div>
                                    </template>
                                </div>
                                <button @click="addMilestone()" class="w-full py-2 border border-dashed border-slate-300 rounded text-slate-500 text-sm hover:bg-slate-50">+ Add Task</button>
                            </div>
                            <div x-show="modalTab==='updates'">
                                <div class="mb-4">
                                    <textarea x-model="newUpdateText" class="w-full border border-slate-200 rounded p-2 text-sm mb-2 h-20" placeholder="Description..."></textarea>
                                    <input x-model="newUpdateLink" class="w-full border border-slate-200 rounded p-2 text-sm mb-2" placeholder="URL Evidence...">
                                    <button @click="addUpdate()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm font-bold w-full">Log Evidence</button>
                                </div>
                                <div class="space-y-3">
                                    <template x-for="(u, idx) in currentProject.updates" :key="idx">
                                        <div class="bg-slate-50 p-3 rounded border border-slate-100 text-sm">
                                            <div class="flex justify-between text-slate-400 text-[10px] mb-1"><span x-text="formatDate(u.date)"></span><span x-text="u.source"></span></div>
                                            <div class="font-medium text-slate-800" x-text="u.text"></div>
                                            <a x-show="u.link" :href="u.link" target="_blank" class="text-blue-600 text-xs mt-1 block">View Link</a>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="toast show">
                <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                <div class="flex-1">
                    <div class="font-bold text-sm text-slate-800">Success</div>
                    <div class="text-xs text-slate-500" x-text="toast.message"></div>
                </div>
            </div>
        </template>
    </div>

    <script>
        function appData() {
            return {
                view: 'dashboard', dashboardMode: 'strategy', fileHandle: null, showModal: false, modalTab: 'tasks', activeStrategyTab: 0, reportTab: 'overview', timelineTab: 'all',
                searchQuery: '', filterRag: '', filterType: '', filterPriority: '', filterKpi: '',
                reportDrillDownCategory: '', reportDrillDownValue: '',
                newTodo: '', newUpdateText: '', newUpdateLink: '', newUpdateSource: '',
                newMeetingTitle: '', newMeetingNotes: '', newMeetingMilestone: '', activeMeetingCategory: '', currentMeeting: null, quickActionText: '',
                timelineMode: 'year',
                projects: [], todos: [], meetingNotes: [], toasts: [],
                settings: { priorities: [], kpis: [], qaSources: [], meetingCategories: [] }, 
                currentProject: {}, charts: {}, 
                
                navItems: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'fas fa-home' },
                    { id: 'strategy', label: 'Strategy', icon: 'fas fa-chess' },
                    { id: 'projects', label: 'Projects', icon: 'fas fa-folder-open' },
                    { id: 'meetings', label: 'Meeting Hub', icon: 'fas fa-users' },
                    { id: 'gantt', label: 'Timeline', icon: 'fas fa-stream' },
                    { id: 'reports', label: 'Reports', icon: 'fas fa-chart-pie' }
                ],

                async init() {
                    // Defaults
                    this.settings.kpis = ['Teaching Quality Indicators', 'QIP Traction', 'Staff Capability', 'Staff Confidence', 'Student Experience', 'Retention Proxy', 'Value for Money', 'Digital Champions'];
                    this.settings.qaSources = ['Learning Walk Data', 'TLA Profile', 'QIP Review', 'Coaching Record', 'Staff Survey', 'Learner Voice', 'Exit Interview', 'Teams Analytics', 'Other'];
                    this.settings.meetingCategories = ['1:1 Line Manager (Neil Davies)', 'Wider Leadership', 'Heads of Area (HoA)', 'Digital Lead Meetings', 'Digital Champions', 'TLAMs', 'Quality Team', 'External Stakeholders', 'Other'];
                    this.activeMeetingCategory = this.settings.meetingCategories[0];
                },
                
                showToast(msg) {
                    const id = Date.now();
                    this.toasts.push({ id, message: msg });
                    setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, 3000);
                },

                async openFile() {
                    try {
                        const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON Data', accept: { 'application/json': ['.json'] } }], multiple: false });
                        this.fileHandle = handle; const file = await handle.getFile(); const text = await file.text();
                        if (text.trim()) {
                            const data = JSON.parse(text);
                            this.projects = (data.projects || []).map(p => ({ ...p, milestones: (p.milestones || []).map(m => ({...m, uuid: m.uuid || Date.now() + Math.random()})), updates: p.updates || [], meetings: p.meetings || [], deptCode: p.deptCode||'', tlam: p.tlam||'', staff: p.staff||'', kpi: p.kpi||'', qaLink: p.qaLink||'', isQip: p.isQip||false }));
                            this.todos = (data.todos || []).map(t => ({...t, originalId: t.originalId || null})); 
                            this.meetingNotes = (data.meetingNotes || []).map(n => ({...n, id: n.id || Date.now() + Math.random()}));
                            this.settings.priorities = (data.settings?.priorities || []).map((p,i) => ({ ...p, id: p.id||(i+1), strategicMilestones: p.strategicMilestones||[], tasks: p.tasks||[] }));
                            this.settings.kpis = data.settings?.kpis || this.settings.kpis;
                            this.settings.qaSources = data.settings?.qaSources || this.settings.qaSources;
                            this.settings.meetingCategories = data.settings?.meetingCategories || this.settings.meetingCategories;
                            this.$nextTick(() => this.initCharts());
                            this.showToast('Data Loaded Successfully');
                        }
                    } catch (err) { console.error(err); alert("Error connecting."); }
                },
                async saveToFile() {
                    if (!this.fileHandle) return;
                    try {
                        const writable = await this.fileHandle.createWritable();
                        await writable.write(JSON.stringify({ projects: this.projects, settings: this.settings, todos: this.todos, meetingNotes: this.meetingNotes }, null, 2));
                        await writable.close();
                        if(this.view === 'dashboard' && document.getElementById('priorityChart')) this.updateCharts();
                    } catch (err) { console.error('Save failed', err); }
                },

                // --- Standard Logic & Getters ---
                get filteredMeetings() { if(!this.activeMeetingCategory) return []; return this.meetingNotes.filter(n => n.category === this.activeMeetingCategory).sort((a,b) => new Date(b.date) - new Date(a.date)); },
                createNewMeeting() { const newNote = { id: Date.now(), title: '', date: new Date().toISOString().split('T')[0], category: this.activeMeetingCategory, content: '', attendees: '', linkedProjectId: '' }; this.meetingNotes.unshift(newNote); this.currentMeeting = newNote; this.saveToFile(); },
                deleteMeeting() { if(this.currentMeeting && confirm('Delete note?')) { this.meetingNotes = this.meetingNotes.filter(n => n.id !== this.currentMeeting.id); this.currentMeeting = null; this.saveToFile(); } },
                addNewMeetingCategory() { const name = prompt("New Category Name:"); if(name && !this.settings.meetingCategories.includes(name)) { this.settings.meetingCategories.push(name); this.activeMeetingCategory = name; this.saveToFile(); } },
                pushActionToDashboard() { if(!this.quickActionText) return; this.todos.push({ text: this.quickActionText, completed: false, projectTitle: 'Meeting Action', originalId: null }); this.quickActionText = ''; this.saveToFile(); this.showToast('Action added to Dashboard'); },
                
                getDrillDownOptions() { if (!this.reportDrillDownCategory) return []; const key = this.reportDrillDownCategory; const values = new Set(this.projects.map(p => p[key]).filter(v => v)); return Array.from(values).sort(); },
                getDrillDownResults() { if (!this.reportDrillDownCategory || !this.reportDrillDownValue) return []; return this.projects.filter(p => p[this.reportDrillDownCategory] === this.reportDrillDownValue); },

                get timelineColumns() {
                    const today = new Date(); const cols = [];
                    if (this.timelineMode === 'year') { const currentYear = today.getFullYear(); for(let i=0; i<12; i++) { const d = new Date(currentYear, i, 1); cols.push({ label: d.toLocaleString('default', {month:'short'}), sub: d.getFullYear(), start: d, end: new Date(currentYear, i+1, 0) }); } }
                    else if (this.timelineMode === '6m') { for(let i=0; i<6; i++) { const d = new Date(today.getFullYear(), today.getMonth() + i, 1); cols.push({ label: d.toLocaleString('default', {month:'short'}), sub: d.getFullYear(), start: d, end: new Date(d.getFullYear(), d.getMonth()+1, 0) }); } }
                    else if (this.timelineMode === '3m') { const start = new Date(today); start.setDate(today.getDate() - today.getDay() + 1); for(let i=0; i<12; i++) { const wStart = new Date(start); wStart.setDate(start.getDate() + (i*7)); const wEnd = new Date(wStart); wEnd.setDate(wStart.getDate() + 6); cols.push({ label: 'W' + (i+1), sub: wStart.getDate() + '/' + (wStart.getMonth()+1), start: wStart, end: wEnd }); } }
                    else if (this.timelineMode === '1m') { for(let i=0; i<30; i++) { const d = new Date(today); d.setDate(today.getDate() + i); cols.push({ label: d.getDate(), sub: d.toLocaleString('default',{weekday:'short'}), start: new Date(d.setHours(0,0,0,0)), end: new Date(d.setHours(23,59,59,999)) }); } }
                    return cols;
                },
                getTimelineGridStyle() { return `grid-template-columns: 200px repeat(${this.timelineColumns.length}, minmax(${this.timelineMode === '1m' ? '30px' : '50px'}, 1fr));`; },
                getDynamicGanttBarStyle(p, idx) {
                    const pStart = new Date(p.startDate); const pEnd = new Date(p.endDate); const cols = this.timelineColumns;
                    if (!this.hasDates(p)) return 'display:none';
                    let startIndex = -1; let endIndex = -1;
                    for(let i=0; i<cols.length; i++) { if (pStart <= cols[i].end && startIndex === -1) startIndex = i; if (pEnd >= cols[i].start) endIndex = i; }
                    if (endIndex < 0 || startIndex === -1 || pEnd < cols[0].start || pStart > cols[cols.length-1].end) return 'display:none';
                    const gridStart = Math.max(0, startIndex) + 2; const span = (Math.min(cols.length - 1, endIndex) - Math.max(0, startIndex)) + 1;
                    return `grid-column: ${gridStart} / span ${span}; grid-row: ${idx + 2}; align-self: center;`;
                },
                isProjectVisibleInTimeline(p) { return !this.getDynamicGanttBarStyle(p, 0).includes('display:none'); },

                copyToToday(task, proj) { if (!task.uuid) task.uuid = Date.now() + Math.random().toString(16).slice(2); if(this.todos.find(t => t.originalId === task.uuid)) return this.showToast("Already in Today's list"); this.todos.push({ text: task.title, completed: task.completed, projectTitle: proj.title, originalId: task.uuid, projectId: proj.id }); this.saveToFile(); this.showToast("Added to Dashboard"); },
                syncFromDashboard(todo) { const proj = this.projects.find(p => p.id === todo.projectId); if(proj) { const task = proj.milestones.find(m => m.uuid === todo.originalId); if(task) { task.completed = todo.completed; if(task.completed) { task.completedDate = new Date().toISOString(); confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } }); } else { task.completedDate = null; } } } this.saveToFile(); },
                syncFromProject(task, proj) { if(!task.uuid) task.uuid = Date.now() + Math.random().toString(16).slice(2); if(task.completed) { task.completedDate = new Date().toISOString(); confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } }); } else { task.completedDate = null; } const todo = this.todos.find(t => t.originalId === task.uuid); if(todo) todo.completed = task.completed; this.saveToFile(); },
                deleteTodo(idx) { this.todos.splice(idx, 1); this.saveToFile(); },
                
                getReportTabIds() { return this.settings.priorities.map(p => p.id).concat(['standalone']); },
                getReportTitle(pId) { if(pId === 'standalone') return 'Stand-alone Projects'; const p = this.settings.priorities.find(x => x.id === pId); return p ? p.title : 'Unknown'; },
                getProjectsForReport(pId) { if(pId === 'standalone') return this.projects.filter(p => !p.priorityId); return this.projects.filter(p => p.priorityId === pId); },
                calculatePriorityTotalProgress(pId) { const projs = this.getProjectsForReport(pId); if (projs.length === 0) return 0; const total = projs.reduce((acc, p) => acc + this.calculateProgress(p), 0); return Math.round(total / projs.length); },
                calculateMilestoneProgress(pId, mTitle) { const projs = this.getProjectsForMilestone(pId, mTitle); if (projs.length === 0) return 0; const total = projs.reduce((acc, p) => acc + this.calculateProgress(p), 0); return Math.round(total / projs.length); },
                
                addPriority() { this.settings.priorities.push({ id: Date.now(), title: 'New Priority', details: '', strategicMilestones: [], tasks: [] }); this.activeStrategyTab = this.settings.priorities.length - 1; },
                createProjectFromAction(priority, milestone) { const name = prompt("Enter Name:", milestone.title); if(!name) return; const newProj = { id: Date.now(), title: name, priorityId: priority.id, milestoneLink: milestone.title, type: 'Strategy', status: 'Active', startDate: new Date().toISOString().split('T')[0], endDate: milestone.targetDate || '', milestones: [], updates: [], meetings: [], deptCode: '', tlam: '', kpi: '', qaLink: '', isQip: false, staff: '' }; this.projects.push(newProj); this.saveToFile(); this.showToast(`Project created`); },
                resetFilters() { this.searchQuery=''; this.filterRag=''; this.filterType=''; this.filterPriority=''; this.filterKpi=''; },
                addTodo() { if(this.newTodo) { this.todos.push({text: this.newTodo, completed: false, projectTitle: 'Manual'}); this.newTodo = ''; this.saveToFile(); }},
                addUpdate() { if(this.newUpdateText) { this.currentProject.updates.push({ date: new Date().toISOString(), text: this.newUpdateText, link: this.newUpdateLink, source: this.newUpdateSource }); this.newUpdateText = ''; this.newUpdateLink = ''; this.newUpdateSource = ''; this.saveToFile(); this.showToast('Evidence Added'); }},
                getMonthName(m) { const d = new Date(); d.setMonth(m-1); return d.toLocaleString('default', { month: 'short' }); },
                hasDates(p) { return p.startDate && p.endDate; },
                getPriorityColor(pId) { if(!pId) return 'bg-slate-500'; const idx = this.settings.priorities.findIndex(p => p.id == pId); return this.getHeaderColor(idx).replace('bg-', 'bg-').replace('-600', '-500'); },
                addStratMilestone(p) { if(!p.strategicMilestones) p.strategicMilestones = []; p.strategicMilestones.push({ title: 'New Phase', targetDate: '', status: 'Planned' }); },
                addStrategyTask(p) { if(!p.tasks) p.tasks=[]; p.tasks.push({name:'New Task', completed:false}); },
                getMilestonesForPriority(pId) { const p = this.settings.priorities.find(x => x.id == pId); return p ? p.strategicMilestones : []; },
                getProjectsForMilestone(pId, mTitle) { return this.projects.filter(p => p.priorityId == pId && p.milestoneLink == mTitle); },
                getProjectsForPriority(pId) { return this.projects.filter(p => p.priorityId == pId); },
                getProjectStrategyName(p) { if (!p.priorityId) return null; const prio = this.settings.priorities.find(x => x.id == p.priorityId); if (!prio) return null; return p.milestoneLink ? p.milestoneLink : prio.title; },
                getAllDueTasks() { let all = []; this.projects.forEach(p => (p.milestones||[]).forEach(m => { if (!m.completed && m.dueDate) all.push({id:Math.random(), projectId:p.id, projectName:p.title, title:m.title, dueDate:m.dueDate, context:'Task', isStrategy: false}); })); return all.sort((a,b)=>a.dueDate.localeCompare(b.dueDate)).slice(0, 30); },
                formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB') : ''; },
                formatDateShort(d) { return d ? new Date(d).toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit'}) : ''; },
                getHeaderColor(idx) { return ['bg-blue-600', 'bg-amber-500', 'bg-emerald-600', 'bg-purple-600', 'bg-pink-600'][idx % 5]; },
                getHeaderTextColor(idx) { return ['text-blue-600', 'text-amber-500', 'text-emerald-600', 'text-purple-600', 'text-pink-600'][idx % 5]; },
                getProjectHeaderColor(pId) { if(!pId) return 'bg-slate-500'; const idx = this.settings.priorities.findIndex(p => p.id == pId); return idx !== -1 ? this.getHeaderColor(idx) : 'bg-slate-500'; },
                getRagBorder(dateStr) { if (!dateStr) return 'border-slate-200'; const today = new Date(); today.setHours(0,0,0,0); const due = new Date(dateStr); const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24)); if (diffDays < 0) return 'border-red-600 border-l-4'; if (diffDays <= 7) return 'border-red-500 border-l-4'; if (diffDays <= 14) return 'border-orange-400 border-l-4'; return 'border-green-500 border-l-4'; },
                getRagColor(dateStr) { if (!dateStr) return 'bg-slate-200'; const today = new Date(); today.setHours(0,0,0,0); const due = new Date(dateStr); const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24)); if (diffDays < 0) return 'bg-red-600'; if (diffDays <= 7) return 'bg-red-500'; if (diffDays <= 14) return 'bg-orange-400'; return 'bg-green-500'; },
                switchView(v) { this.view = v; if(v==='dashboard') setTimeout(()=>this.updateCharts(),100); },
                startNewProject() { this.currentProject = { id: Date.now() + Math.random(), title: '', priorityId: '', milestoneLink: '', type: 'coaching', milestones: [], updates: [], status: 'Active', deptCode: '', tlam: '', startDate: '', endDate: '', staff: '', meetings: [] }; this.showModal = true; this.modalTab = 'tasks'; },
                editProject(p) { this.currentProject = p; this.showModal = true; this.modalTab = 'tasks'; }, 
                saveProject() { 
                    const idx = this.projects.findIndex(x => x.id === this.currentProject.id); 
                    if(idx === -1) { this.projects = [...this.projects, this.currentProject]; } 
                    else { const newProjs = [...this.projects]; newProjs[idx] = this.currentProject; this.projects = newProjs; }
                    this.saveToFile(); this.showModal = false; 
                },
                addMilestone() { if(!this.currentProject.milestones) this.currentProject.milestones=[]; this.currentProject.milestones.push({title:'New Task', completed:false, completedDate: null, uuid: Date.now() + Math.random().toString(16).slice(2)}); },
                
                get filteredProjects() { return this.projects.filter(p => { 
                    const matchesSearch = p.title.toLowerCase().includes(this.searchQuery.toLowerCase()); 
                    if(this.filterRag) { const border = this.getRagBorder(p.endDate); if(!border.includes(this.filterRag)) return false; } 
                    if(this.filterType && p.type && p.type.toLowerCase() !== this.filterType.toLowerCase()) return false; 
                    if(this.filterPriority) { if(this.filterPriority === 'standalone') { if(p.priorityId) return false; } else if(p.priorityId != this.filterPriority) return false; }
                    if(this.filterKpi && p.kpi !== this.filterKpi) return false;
                    return matchesSearch; 
                }); },
                get timelineProjects() {
                    const all = this.filteredProjects;
                    if (this.timelineTab === 'all') return all;
                    if (this.timelineTab === 'standalone') return all.filter(p => !p.priorityId);
                    return all.filter(p => p.priorityId === this.timelineTab);
                },

                calculateProgress(p) { return !p.milestones?.length ? 0 : Math.round((p.milestones.filter(m=>m.completed).length / p.milestones.length)*100); },
                exportToExcel() {
                    let csvContent = "data:text/csv;charset=utf-8,Priority,Project Title,KPI,QA Mechanism,Staff,Dept,Start Date,End Date,Status,Completion %\n";
                    this.projects.forEach(p => {
                        const prioTitle = p.priorityId ? (this.settings.priorities.find(pri => pri.id == p.priorityId)?.title || 'Standalone') : 'Standalone';
                        const progress = this.calculateProgress(p);
                        const row = `"${prioTitle}","${p.title}","${p.kpi}","${p.qaLink}","${p.staff}","${p.deptCode}","${p.startDate}","${p.endDate}","${p.status}","${progress}%"`;
                        csvContent += row + "\n";
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "project_data.csv");
                    document.body.appendChild(link);
                    link.click();
                },

                initCharts() {
                    const pCtx = document.getElementById('priorityChart')?.getContext('2d');
                    const pipeCtx = document.getElementById('pipelineChart')?.getContext('2d');
                    if(this.charts.priority) this.charts.priority.destroy();
                    if(this.charts.pipeline) this.charts.pipeline.destroy();

                    const isGov = this.dashboardMode === 'governance';
                    const pData = isGov ? this.getKpiData() : this.getPriorityData();

                    if(pCtx) this.charts.priority = new Chart(pCtx, { type: 'doughnut', data: pData, options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => { if(el.length > 0) this.switchView('projects'); } } });
                    if(pipeCtx) this.charts.pipeline = new Chart(pipeCtx, { type: 'bar', data: this.getPipelineData(), options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, onClick: (e, el) => { if(el.length > 0) this.switchView('projects'); } } });
                },
                updateCharts() { this.initCharts(); },
                getPriorityData() { return { labels: this.settings.priorities.map(p => (p.title || 'Untitled').substring(0, 15)+'...'), datasets: [{ data: this.settings.priorities.map(p => this.projects.filter(proj => proj.priorityId == p.id).length), backgroundColor: ['#2563eb', '#f59e0b', '#059669', '#7c3aed', '#db2777'], borderWidth: 0 }] }; },
                getKpiData() { return { labels: this.settings.kpis.map(k => k.substring(0, 15)+'...'), datasets: [{ data: this.settings.kpis.map(k => this.projects.filter(p => p.kpi == k).length), backgroundColor: ['#9333ea', '#c084fc', '#a855f7', '#7e22ce', '#6b21a8', '#581c87', '#3b0764', '#d8b4fe'], borderWidth: 0 }] }; },
                getPipelineData() { return { labels: ['Active Cases', 'Completed Cases'], datasets: [{ label: 'Projects', data: [this.projects.filter(p => p.status !== 'Completed').length, this.projects.filter(p => p.status === 'Completed').length], backgroundColor: ['#3b82f6', '#10b981'] }] }; },
            }
        }
    </script>
</body>
</html>
