<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Impact Hub v25.5 (Governance & QA)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            .break-avoid { break-inside: avoid; }
        }
        /* Dynamic Gantt Grid */
        .gantt-container { overflow-x: auto; padding-bottom: 10px; }
        .gantt-grid { display: grid; gap: 0; } 
        .gantt-row { display: contents; } 
        .gantt-header { font-size: 0.70rem; font-weight: bold; text-align: center; padding: 6px 2px; background: #f1f5f9; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; justify-content: center; align-items: center; line-height: 1.1; height: 100%; }
        .gantt-cell { background: #fff; border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; height: 40px; }
        .gantt-sticky-col { position: sticky; left: 0; z-index: 20; background: white; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; height: 40px; display: flex; align-items: center; }
        .progress-bar { transition: width 1s ease-in-out; }
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col" x-data="appData()" x-init="init()">

    <header class="bg-slate-900 text-white p-4 flex justify-between items-center shadow-lg no-print z-30 relative">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 w-10 h-10 rounded flex items-center justify-center font-bold text-xl shadow-inner">DC</div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Digital Impact Hub</h1>
                <p class="text-xs text-slate-400">Strategy & Execution</p>
            </div>
        </div>
        
        <div class="flex items-center bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
            <template x-if="!fileHandle">
                <div class="flex items-center gap-2 text-amber-400 animate-pulse">
                    <i class="fas fa-exclamation-triangle"></i><span class="text-xs font-bold uppercase">Not Connected</span>
                </div>
            </template>
            <template x-if="fileHandle">
                <div class="flex items-center gap-2 text-emerald-400">
                    <i class="fas fa-link"></i><span class="text-xs font-bold uppercase">Live Linked</span>
                </div>
            </template>
        </div>

        <div class="flex gap-2">
             <template x-if="!fileHandle">
                <button @click="openFile()" class="text-sm bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold shadow transition"><i class="fas fa-folder-open mr-2"></i> Connect</button>
             </template>
             <template x-if="fileHandle">
                <button @click="saveToFile()" class="text-sm bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded font-bold shadow transition"><i class="fas fa-save mr-2"></i> Save</button>
             </template>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-6 relative">
        
        <div x-show="!fileHandle" class="max-w-2xl mx-auto mt-20 text-center">
            <div class="bg-white p-12 rounded-xl shadow-2xl border border-slate-200">
                <div class="text-7xl text-slate-300 mb-6"><i class="fas fa-sync-alt"></i></div>
                <h2 class="text-3xl font-bold text-slate-800 mb-4">Connect Your Hub</h2>
                <button @click="openFile()" class="bg-blue-600 text-white text-lg px-8 py-4 rounded shadow-lg hover:bg-blue-700 transition">Select File from OneDrive</button>
            </div>
        </div>

        <div x-show="fileHandle" x-transition>
            
            <div class="flex justify-center gap-8 mb-8 border-b border-slate-200 pb-4 no-print">
                <button @click="switchView('dashboard')" :class="view==='dashboard' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-blue-600'" class="pb-2 font-bold transition flex items-center gap-2"><i class="fas fa-home"></i> Dashboard</button>
                <button @click="switchView('strategy')" :class="view==='strategy' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-blue-600'" class="pb-2 font-bold transition flex items-center gap-2"><i class="fas fa-chess"></i> Strategy Pillars</button>
                <button @click="switchView('projects')" :class="view==='projects' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-blue-600'" class="pb-2 font-bold transition flex items-center gap-2"><i class="fas fa-folder-open"></i> Projects</button>
                <button @click="switchView('gantt')" :class="view==='gantt' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-blue-600'" class="pb-2 font-bold transition flex items-center gap-2"><i class="fas fa-stream"></i> Timeline</button>
                <button @click="switchView('reports')" :class="view==='reports' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-blue-600'" class="pb-2 font-bold transition flex items-center gap-2"><i class="fas fa-chart-pie"></i> Impact Reports</button>
            </div>

            <div x-show="view === 'dashboard'" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div class="lg:col-span-2 space-y-8">
                    <div class="flex justify-between items-center bg-white p-2 rounded shadow-sm border border-slate-200">
                        <div class="text-sm font-bold text-slate-500 uppercase px-2">View Mode:</div>
                        <div class="flex bg-slate-100 rounded p-1">
                            <button @click="dashboardMode='strategy'; updateCharts()" :class="dashboardMode==='strategy'?'bg-white text-blue-600 shadow':'text-slate-500'" class="px-4 py-1 rounded text-xs font-bold transition">Strategy</button>
                            <button @click="dashboardMode='governance'; updateCharts()" :class="dashboardMode==='governance'?'bg-white text-purple-600 shadow':'text-slate-500'" class="px-4 py-1 rounded text-xs font-bold transition">Governance (KPIs)</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                            <div class="text-xs font-bold text-slate-400 uppercase">Active Projects</div>
                            <div class="text-2xl font-bold" x-text="projects.filter(p=>p.status!=='Completed').length"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow border-l-4 border-amber-500">
                            <div class="text-xs font-bold text-slate-400 uppercase">Actions Due</div>
                            <div class="text-2xl font-bold" x-text="getAllDueTasks().length"></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow border-l-4 border-purple-500">
                            <div class="text-xs font-bold text-slate-400 uppercase">QIP Traction</div>
                            <div class="text-2xl font-bold" x-text="projects.filter(p => p.isQip).length"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 h-64">
                        <div class="bg-white p-4 rounded shadow-sm cursor-pointer hover:shadow-md transition relative" @click="switchView('projects')">
                            <h3 class="font-bold text-slate-700 mb-2 text-sm" x-text="dashboardMode==='strategy' ? 'Strategic Focus' : 'KPI Alignment'"></h3>
                            <div class="h-48"><canvas id="priorityChart"></canvas></div>
                        </div>
                        <div class="bg-white p-4 rounded shadow-sm cursor-pointer hover:shadow-md transition">
                            <h3 class="font-bold text-slate-700 mb-2 text-sm">Pipeline</h3>
                            <div class="h-48"><canvas id="pipelineChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md border border-slate-200 flex flex-col h-full">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center"><h3 class="font-bold text-lg text-slate-800">Today's Focus</h3><span class="text-xs text-slate-500" x-text="new Date().toLocaleDateString()"></span></div>
                    <div class="p-4 flex-1 overflow-y-auto">
                        <div class="flex gap-2 mb-4"><input x-model="newTodo" @keydown.enter="addTodo()" placeholder="Quick task..." class="flex-1 border p-2 rounded text-sm"><button @click="addTodo()" class="bg-blue-600 text-white px-3 rounded"><i class="fas fa-plus"></i></button></div>
                        <div class="space-y-2"><template x-for="(todo, idx) in todos" :key="idx"><div class="flex items-start gap-2 p-2 rounded border transition" :class="todo.completed ? 'bg-slate-50 opacity-75' : 'bg-white'"><input type="checkbox" x-model="todo.completed" @change="syncFromDashboard(todo)" class="mt-1.5 cursor-pointer"><div class="flex-1"><div class="text-sm font-medium" :class="{'line-through text-slate-400': todo.completed}" x-text="todo.text"></div><div x-show="todo.projectTitle" class="text-[10px] text-blue-600 bg-blue-50 inline-block px-1 rounded mt-1" x-text="todo.projectTitle"></div></div><button @click="deleteTodo(idx)" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></template></div>
                    </div>
                </div>
            </div>

            <div x-show="view === 'strategy'" class="max-w-6xl mx-auto">
                <div class="flex flex-wrap gap-2 mb-6 border-b border-slate-200 pb-2">
                    <template x-for="(p, idx) in settings.priorities" :key="idx">
                        <button @click="activeStrategyTab = idx" class="px-4 py-2 rounded-t-lg font-bold text-sm transition border-t-4 shadow-sm" :class="activeStrategyTab === idx ? 'bg-slate-900 text-white border-blue-500' : 'bg-slate-100 text-slate-700 hover:bg-slate-200 border-transparent'"><span x-text="'Priority ' + (idx + 1)"></span></button>
                    </template>
                    <button @click="addPriority()" class="px-4 py-2 rounded-t-lg font-bold text-sm bg-slate-800 text-white hover:bg-slate-700 ml-4">+ Priority</button>
                </div>
                <div class="bg-white rounded-b-lg rounded-tr-lg shadow-md border border-slate-200 overflow-hidden min-h-[600px]">
                    <template x-if="settings.priorities[activeStrategyTab]">
                        <div>
                            <div class="p-4 flex justify-between items-center" :class="getHeaderColor(activeStrategyTab)"><h3 class="font-bold text-lg text-white" x-text="'Priority ' + (activeStrategyTab + 1)"></h3></div>
                            <div class="p-6">
                                <input x-model="settings.priorities[activeStrategyTab].title" class="w-full text-lg font-bold border-b-2 border-slate-200 focus:border-blue-500 outline-none mb-4 pb-1 transition">
                                <textarea x-model="settings.priorities[activeStrategyTab].details" class="w-full text-sm p-3 bg-slate-50 border rounded mb-6 h-24 outline-none"></textarea>
                                <div class="bg-purple-50 rounded p-4 border border-purple-100 mb-6">
                                    <div class="flex justify-between items-center mb-4"><h4 class="font-bold text-sm text-purple-900">Strategic Milestones</h4><button @click="addStratMilestone(settings.priorities[activeStrategyTab])" class="text-xs bg-white border border-purple-200 px-3 py-1 rounded">+ Add</button></div>
                                    <template x-for="(sm, smIdx) in settings.priorities[activeStrategyTab].strategicMilestones" :key="smIdx">
                                        <div class="bg-white p-4 rounded shadow-sm border border-purple-100 mb-3 flex gap-4">
                                            <div class="w-16 flex-shrink-0 flex flex-col items-center justify-center"><div class="relative w-12 h-12"><svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36"><path class="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" /><path class="text-blue-600" :stroke-dasharray="calculateMilestoneProgress(settings.priorities[activeStrategyTab].id, sm.title) + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" /></svg><div class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-blue-700" x-text="calculateMilestoneProgress(settings.priorities[activeStrategyTab].id, sm.title) + '%'"></div></div></div>
                                            <div class="flex-1">
                                                <div class="flex justify-between items-start mb-3 border-b border-slate-100 pb-2"><input x-model="sm.title" class="w-1/2 text-sm font-bold border-b border-transparent focus:border-purple-300 outline-none"><div class="flex gap-2"><input type="date" x-model="sm.targetDate" class="text-xs border rounded p-1"><button @click="settings.priorities[activeStrategyTab].strategicMilestones.splice(smIdx, 1)" class="text-slate-300 hover:text-red-400"><i class="fas fa-times"></i></button></div></div>
                                                <div class="pl-4 border-l-2 border-slate-200"><div class="flex justify-between items-center mb-2"><span class="text-[10px] font-bold uppercase text-slate-400">Core Actions</span><button @click="createProjectFromAction(settings.priorities[activeStrategyTab], sm)" class="text-[10px] bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 border border-blue-200">+ Action</button></div>
                                                    <div class="space-y-1"><template x-for="proj in getProjectsForMilestone(settings.priorities[activeStrategyTab].id, sm.title)"><div class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100 hover:bg-slate-100 cursor-pointer" @click="editProject(proj)"><div class="flex items-center gap-2"><i class="fas fa-project-diagram text-blue-500 text-xs"></i><span class="text-xs font-bold text-slate-700" x-text="proj.title"></span></div><div class="flex items-center gap-2"><div class="w-16 bg-slate-200 rounded-full h-1.5"><div class="bg-blue-500 h-1.5 rounded-full" :style="`width: ${calculateProgress(proj)}%`"></div></div></div></div></template></div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div class="bg-slate-50 rounded p-4 border border-slate-200 mt-6"><div class="flex justify-between items-center mb-3"><h4 class="font-bold text-sm text-slate-700">General Actions</h4><button @click="addStrategyTask(settings.priorities[activeStrategyTab])" class="text-xs bg-white border border-slate-300 px-3 py-1 rounded shadow-sm">+ Add</button></div><div class="space-y-2 grid grid-cols-1 md:grid-cols-2 gap-4"><template x-for="(task, tIdx) in settings.priorities[activeStrategyTab].tasks" :key="tIdx"><div class="bg-white p-2 rounded shadow-sm border border-slate-100 flex items-center gap-2"><input type="checkbox" x-model="task.completed" class="w-4 h-4 rounded"><input x-model="task.name" class="flex-1 text-sm bg-transparent border-none outline-none"><input type="date" x-model="task.dueDate" class="text-xs bg-transparent border-none text-slate-600 w-24"><button @click="settings.priorities[activeStrategyTab].tasks.splice(tIdx, 1)" class="text-slate-300 hover:text-red-400"><i class="fas fa-times"></i></button></div></template></div></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'projects'" class="max-w-7xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
                    <div class="flex gap-2 items-center flex-wrap">
                        <input x-model="searchQuery" placeholder="Search projects..." class="border p-2 rounded w-64 text-sm shadow-inner">
                        <select x-model="filterPriority" class="border p-2 rounded text-sm bg-white">
                            <option value="">All Priorities</option>
                            <template x-for="p in settings.priorities" :key="p.id"><option :value="p.id" x-text="p.title"></option></template>
                            <option value="standalone">Stand-alone Only</option>
                        </select>
                        <select x-model="filterKpi" class="border p-2 rounded text-sm bg-white font-bold text-purple-700">
                            <option value="">All KPIs</option>
                            <template x-for="k in settings.kpis"><option :value="k" x-text="k"></option></template>
                        </select>
                        <select x-model="filterRag" class="border p-2 rounded text-sm bg-white"><option value="">All Status</option><option value="red">Critical (Red)</option><option value="orange">Warning (Orange)</option><option value="green">On Track (Green)</option></select>
                        <button x-show="searchQuery||filterRag||filterPriority||filterKpi" @click="resetFilters()" class="text-xs text-slate-500 underline">Reset</button>
                    </div>
                    <button @click="startNewProject()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-700 shadow">+ New Project</button>
                </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="project in filteredProjects" :key="project.id">
                        <div class="bg-white rounded-lg shadow-sm border border-slate-200 transition card-hover flex flex-col h-full cursor-pointer group" :class="getRagBorder(project.endDate)" @click="editProject(project)">
                            <div class="p-3 text-white flex justify-between items-start" :class="getProjectHeaderColor(project.priorityId)"><h3 class="font-bold text-sm truncate pr-2" x-text="project.title"></h3><span class="text-[9px] bg-white/20 px-2 py-0.5 rounded uppercase font-bold" x-text="project.type"></span></div>
                            <div class="p-4 flex-1 flex flex-col">
                                <div class="flex flex-wrap gap-1 mb-2">
                                    <span x-show="project.deptCode" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded border border-gray-200" x-text="project.deptCode"></span>
                                    <span x-show="project.isQip" class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded border border-red-200 font-bold">QIP</span>
                                    <span x-show="project.kpi" class="text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded border border-purple-100" x-text="project.kpi.substring(0,15)+'...'"></span>
                                </div>
                                <div x-show="getProjectStrategyName(project)" class="mb-3"><span class="text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded truncate block w-full border border-slate-200"><i class="fas fa-link mr-1"></i> <span x-text="getProjectStrategyName(project)"></span></span></div>
                                <p class="text-xs text-slate-500 mb-2 line-clamp-2" x-text="project.objective || 'No objective set.'"></p>
                                <div class="mt-auto pt-2 border-t border-slate-100"><div class="flex justify-between items-center text-[10px] text-slate-400 mb-1"><span x-show="project.endDate">Due: <span x-text="formatDate(project.endDate)" class="font-bold text-slate-600"></span></span><span x-text="calculateProgress(project) + '%'"></span></div><div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden"><div class="h-1.5 rounded-full progress-bar" :class="calculateProgress(project) === 100 ? 'bg-emerald-500' : 'bg-blue-600'" :style="`width: ${calculateProgress(project)}%`"></div></div></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="view === 'gantt'" class="max-w-full mx-auto">
                <div class="bg-white p-6 rounded shadow mb-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div class="flex items-center gap-4">
                            <h2 class="font-bold text-lg">Timeline</h2>
                            <div class="flex bg-slate-100 rounded p-1">
                                <button @click="timelineMode = 'year'" :class="timelineMode==='year' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 rounded text-xs font-bold transition">12 M</button>
                                <button @click="timelineMode = '6m'" :class="timelineMode==='6m' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 rounded text-xs font-bold transition">6 M</button>
                                <button @click="timelineMode = '3m'" :class="timelineMode==='3m' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 rounded text-xs font-bold transition">3 M (Weekly)</button>
                                <button @click="timelineMode = '1m'" :class="timelineMode==='1m' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1 rounded text-xs font-bold transition">1 M (Daily)</button>
                            </div>
                        </div>
                        <button @click="exportToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-xs"><i class="fas fa-file-excel mr-1"></i> Export Data</button>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-4 border-b border-slate-200">
                        <button @click="timelineTab = 'all'" class="px-4 py-2 text-sm font-bold border-b-2 transition" :class="timelineTab === 'all' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-blue-500'">All Projects</button>
                        <template x-for="(p, idx) in settings.priorities" :key="idx">
                            <button @click="timelineTab = p.id" class="px-4 py-2 text-sm font-bold border-b-2 transition" :class="timelineTab === p.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-blue-500'" x-text="p.title"></button>
                        </template>
                        <button @click="timelineTab = 'standalone'" class="px-4 py-2 text-sm font-bold border-b-2 transition" :class="timelineTab === 'standalone' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-blue-500'">Stand-alone</button>
                    </div>

                    <div class="gantt-container">
                        <div class="gantt-grid text-sm" :style="getTimelineGridStyle()">
                            <div class="gantt-row font-bold text-slate-700 bg-slate-50 border-b border-slate-300 sticky top-0 z-20">
                                <div class="p-3 sticky left-0 bg-slate-50 z-30 border-r border-slate-200 shadow-sm border-bottom">Project / Action</div>
                                <template x-for="(col, idx) in timelineColumns" :key="idx"><div class="gantt-header"><div x-text="col.label"></div><div x-show="col.sub" class="text-[9px] text-slate-400 font-normal" x-text="col.sub"></div></div></template>
                            </div>
                            <template x-for="(p, idx) in timelineProjects" :key="p.id">
                                <div class="gantt-row hover:bg-slate-50 transition group border-b border-slate-100">
                                    <div class="gantt-sticky-col p-2 text-xs font-bold truncate pr-4 cursor-pointer hover:text-blue-600 group-hover:bg-slate-50" :style="`grid-row: ${idx + 2}; grid-column: 1`" @click="editProject(p)"><span x-text="p.title" :title="p.title" class="truncate w-60 block"></span></div>
                                    <template x-for="c in timelineColumns"><div class="gantt-cell group-hover:bg-slate-50" :style="`grid-row: ${idx + 2}`"></div></template>
                                    <div x-show="hasDates(p) && isProjectVisibleInTimeline(p)" class="rounded text-[9px] text-white flex items-center px-2 shadow-sm cursor-pointer hover:opacity-90 overflow-hidden z-10 h-6" :class="getPriorityColor(p.priorityId)" :style="getDynamicGanttBarStyle(p, idx)" @click="editProject(p)"><span class="truncate" x-text="formatDateShort(p.startDate) + ' - ' + formatDateShort(p.endDate)"></span></div>
                                </div>
                            </template>
                            <div x-show="timelineProjects.length === 0" class="p-8 text-center text-slate-400 italic" style="grid-column: 1 / -1; grid-row: 2;">No projects found in this section.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="view === 'reports'" class="max-w-6xl mx-auto h-full flex flex-col">
                <div class="flex justify-between items-center mb-6 no-print">
                    <h2 class="font-bold text-2xl text-slate-800">Impact Reporting</h2>
                    <button @click="window.print()" class="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-700 shadow"><i class="fas fa-print mr-2"></i> Print Report</button>
                </div>
                <div class="flex flex-wrap gap-2 mb-4 border-b border-slate-200 no-print">
                    <button @click="reportTab = 'overview'" class="px-4 py-2 text-sm font-bold border-b-2 transition" :class="reportTab === 'overview' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-blue-500'">Overview</button>
                    <button @click="reportTab = 'kpis'" class="px-4 py-2 text-sm font-bold border-b-2 transition text-purple-600" :class="reportTab === 'kpis' ? 'border-purple-600' : 'border-transparent hover:text-purple-500'">By KPI (Governance)</button>
                    <template x-for="(p, idx) in settings.priorities" :key="idx">
                        <button @click="reportTab = p.id" class="px-4 py-2 text-sm font-bold border-b-2 transition" :class="reportTab === p.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-blue-500'" x-text="p.title"></button>
                    </template>
                    <button @click="reportTab = 'standalone'" class="px-4 py-2 text-sm font-bold border-b-2 transition" :class="reportTab === 'standalone' ? 'border-blue-600 text-blue-600' : 'border-transparent text-slate-500 hover:text-blue-500'">Stand-alone</button>
                </div>

                <div x-show="reportTab === 'kpis'" class="space-y-8 animate-fade-in">
                    <div class="text-center py-4 border-b mb-4"><h2 class="text-2xl font-bold text-purple-800">Governance & KPI Alignment</h2><p class="text-slate-500 text-sm">Mapping projects to Deputy Principal's Indicators</p></div>
                    <div class="grid grid-cols-1 gap-8">
                        <template x-for="k in settings.kpis" :key="k">
                            <div class="bg-white rounded-lg shadow border border-purple-100 overflow-hidden break-avoid">
                                <div class="bg-purple-50 p-4 border-b border-purple-100 flex justify-between items-center">
                                    <h3 class="font-bold text-purple-900" x-text="k"></h3>
                                    <span class="text-xs bg-white px-2 py-1 rounded border border-purple-200" x-text="projects.filter(p => p.kpi === k).length + ' Projects'"></span>
                                </div>
                                <div class="p-4">
                                    <template x-for="proj in projects.filter(p => p.kpi === k)" :key="proj.id">
                                        <div class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0">
                                            <div>
                                                <div class="font-bold text-sm text-slate-700" x-text="proj.title"></div>
                                                <div class="text-xs text-slate-400" x-text="proj.qaLink || 'No QA Link'"></div>
                                            </div>
                                            <div class="flex items-center gap-4">
                                                <span x-show="proj.isQip" class="text-[10px] bg-red-100 text-red-600 px-2 rounded font-bold">QIP</span>
                                                <div class="text-sm font-bold" :class="calculateProgress(proj)==100?'text-green-600':'text-blue-600'" x-text="calculateProgress(proj)+'%'"></div>
                                            </div>
                                        </div>
                                    </template>
                                    <div x-show="projects.filter(p => p.kpi === k).length === 0" class="text-xs text-slate-400 italic">No aligned projects.</div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="reportTab === 'overview'" class="space-y-6">
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <template x-for="(p, idx) in settings.priorities" :key="idx"><div class="bg-white p-6 rounded-lg shadow border border-slate-200 flex items-center justify-between"><div><h3 class="font-bold text-lg text-slate-800 mb-1" x-text="p.title"></h3><p class="text-xs text-slate-500 mb-2" x-text="p.strategicMilestones.length + ' Strategic Milestones'"></p><p class="text-[10px] text-slate-400 uppercase font-bold">Total Progress</p></div><div class="w-20 h-20 relative"><svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36"><path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" /><path :class="getHeaderTextColor(idx)" :stroke-dasharray="calculatePriorityTotalProgress(p.id) + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" /></svg><div class="absolute inset-0 flex items-center justify-center font-bold text-sm text-slate-700" x-text="calculatePriorityTotalProgress(p.id) + '%'"></div></div></div></template>
                    </div>
                </div>
                <template x-for="pId in getReportTabIds()" :key="pId">
                    <div x-show="reportTab === pId" class="space-y-8 animate-fade-in">
                        <div class="text-center py-4 border-b mb-4"><h2 class="text-2xl font-bold text-slate-800" x-text="getReportTitle(pId)"></h2><p class="text-slate-500 text-sm">Detailed Breakdown & Evidence Locker</p></div>
                        <div class="grid grid-cols-1 gap-6">
                            <template x-for="proj in getProjectsForReport(pId)" :key="proj.id">
                                <div x-data="{ expanded: false }" class="bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden break-avoid">
                                    <div @click="expanded = !expanded" class="p-5 cursor-pointer hover:bg-slate-50 transition flex justify-between items-center">
                                        <div class="flex-1"><div class="flex items-center gap-2 mb-1"><h3 class="font-bold text-lg text-slate-800" x-text="proj.title"></h3><span class="text-[10px] bg-slate-100 text-slate-500 px-2 rounded uppercase border" x-text="proj.type"></span></div><div class="text-sm text-slate-500 flex gap-4"><span><i class="fas fa-calendar-alt mr-1"></i> Due: <span x-text="formatDate(proj.endDate)"></span></span><span><i class="fas fa-list-check mr-1"></i> Tasks: <span x-text="proj.milestones.length"></span></span></div></div>
                                        <div class="flex items-center gap-6"><div class="w-14 h-14 relative"><svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36"><path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" /><path class="text-blue-600" :stroke-dasharray="calculateProgress(proj) + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" /></svg><div class="absolute inset-0 flex items-center justify-center font-bold text-xs text-blue-800" x-text="calculateProgress(proj) + '%'"></div></div><div class="text-slate-300"><i class="fas" :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i></div></div>
                                    </div>
                                    <div x-show="expanded" class="bg-slate-50 border-t border-slate-200 p-6 flex flex-col md:flex-row gap-8">
                                        <div class="flex-1"><h4 class="font-bold text-sm uppercase text-slate-400 mb-3 tracking-wide">Micro-Tasks & Status</h4><div class="space-y-2"><template x-for="m in proj.milestones" :key="m.uuid"><div class="flex justify-between items-center bg-white p-2 rounded border border-slate-100 text-sm"><span x-text="m.title"></span><span x-show="m.completed" class="text-green-600 font-bold text-xs"><i class="fas fa-check mr-1"></i> Done</span><span x-show="!m.completed" class="text-slate-400 text-xs italic">Pending</span></div></template><div x-show="!proj.milestones.length" class="text-xs text-slate-400 italic">No tasks defined.</div></div></div>
                                        <div class="flex-1 border-l border-slate-200 pl-8 md:block hidden sm:block"><h4 class="font-bold text-sm uppercase text-slate-400 mb-3 tracking-wide">Evidence Locker & Updates</h4><div class="space-y-3"><template x-for="u in proj.updates" :key="u.date"><div class="text-sm bg-white p-3 rounded border border-slate-100 shadow-sm"><div class="text-[10px] text-slate-400 mb-1 flex justify-between"><span x-text="formatDate(u.date)"></span><span x-show="u.source" class="bg-slate-200 px-1 rounded text-slate-600" x-text="u.source"></span></div><div class="font-medium text-slate-800 mb-1" x-text="u.text"></div><div x-show="u.link"><a :href="u.link" target="_blank" class="text-blue-600 hover:underline text-xs flex items-center gap-1 font-bold"><i class="fas fa-external-link-alt"></i> View Evidence</a></div></div></template><div x-show="!proj.updates.length" class="text-xs text-slate-400 italic">No updates or evidence logged yet.</div></div></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div> 
    </main>

    <div x-show="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" x-cloak>
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl max-h-[95vh] overflow-y-auto">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50"><h3 class="font-bold text-lg">Manage Project</h3><button @click="showModal = false"><i class="fas fa-times"></i></button></div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <input x-model="currentProject.title" class="w-full border p-2 rounded font-bold text-lg" placeholder="Project Name">
                    <div class="bg-blue-50 p-4 rounded border border-blue-100">
                        <select x-model="currentProject.priorityId" class="w-full border p-2 rounded text-sm mb-2"><option value="">-- Stand-alone Project --</option><template x-for="p in settings.priorities" :key="p.id"><option :value="p.id" x-text="p.title"></option></template></select>
                        <select x-model="currentProject.milestoneLink" class="w-full border p-2 rounded text-sm mb-2" x-show="currentProject.priorityId"><option value="">-- Link to Milestone --</option><template x-for="m in getMilestonesForPriority(currentProject.priorityId)" :key="m.title"><option :value="m.title" x-text="m.title"></option></template></select>
                        <div class="grid grid-cols-2 gap-2 mt-2"><div><label class="text-[10px]">Start</label><input type="date" x-model="currentProject.startDate" class="w-full border p-1 rounded text-xs"></div><div><label class="text-[10px]">End</label><input type="date" x-model="currentProject.endDate" class="w-full border p-1 rounded text-xs"></div></div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded border border-purple-100">
                        <label class="block text-xs font-bold text-purple-900 mb-2 uppercase">Governance & Quality</label>
                        <select x-model="currentProject.kpi" class="w-full border p-2 rounded text-sm mb-2"><option value="">-- Link to KPI --</option><template x-for="k in settings.kpis"><option :value="k" x-text="k"></option></template></select>
                        <select x-model="currentProject.qaLink" class="w-full border p-2 rounded text-sm mb-2"><option value="">-- QA Mechanism --</option><template x-for="q in settings.qaSources"><option :value="q" x-text="q"></option></template></select>
                        <div class="flex items-center gap-2 mt-2"><input type="checkbox" x-model="currentProject.isQip" class="w-4 h-4"><span class="text-sm font-bold text-slate-700">Linked to Dept QIP?</span></div>
                    </div>

                    <div class="grid grid-cols-3 gap-2"><div><label class="text-[10px]">Type</label><select x-model="currentProject.type" class="w-full border p-2 rounded text-sm"><option value="coaching">Coaching</option><option value="project">Project</option><option value="strategy">Strategy</option></select></div><div><label class="text-[10px]">Dept</label><input x-model="currentProject.deptCode" list="deptCodes" class="w-full border p-2 rounded text-sm"><datalist id="deptCodes"><option value="AGF"><option value="HAC"><option value="MAT"><option value="ENG"><option value="SKB"></datalist></div><div><label class="text-[10px]">TLAM</label><select x-model="currentProject.tlam" class="w-full border p-2 rounded text-sm"><option value="">-- None --</option><option>Megan Brookes</option><option>Steve Brawley</option><option>Emily Green</option><option>Matt Filer</option><option>Rachel Lane</option><option>Neil Davies</option></select></div></div>
                    <textarea x-model="currentProject.objective" class="w-full border p-2 rounded h-24 text-sm" placeholder="Description..."></textarea>
                </div>
                <div class="flex flex-col h-full">
                    <div class="flex border-b mb-4"><button @click="modalTab='tasks'" :class="modalTab==='tasks'?'border-b-2 border-blue-500 text-blue-600':'text-slate-400'" class="pb-2 px-4 text-sm font-bold w-1/2">Micro-Tasks</button><button @click="modalTab='updates'" :class="modalTab==='updates'?'border-b-2 border-blue-500 text-blue-600':'text-slate-400'" class="pb-2 px-4 text-sm font-bold w-1/2">Evidence & Updates</button></div>
                    <div x-show="modalTab==='tasks'" class="flex-1 flex flex-col">
                        <button @click="addMilestone()" class="text-xs bg-slate-200 px-2 py-2 rounded mb-2 w-full font-bold">+ Add Task</button>
                        <div class="space-y-1 overflow-y-auto max-h-[400px] flex-1"><template x-for="(m, idx) in currentProject.milestones" :key="idx"><div class="bg-white p-2 rounded border flex gap-2 items-center"><input type="checkbox" x-model="m.completed" @change="syncFromProject(m, currentProject)" class="cursor-pointer w-4 h-4"><div class="flex-1"><input x-model="m.title" class="w-full text-sm border-none outline-none bg-transparent"><input type="date" x-model="m.dueDate" class="text-[10px] bg-transparent text-slate-400 border-none p-0 h-4"></div><button @click="copyToToday(m, currentProject)" class="text-slate-300 hover:text-purple-500" title="Add to Today"><i class="fas fa-calendar-day"></i></button><button @click="currentProject.milestones.splice(idx, 1)" class="text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></template></div>
                    </div>
                    <div x-show="modalTab==='updates'" class="flex-1 flex flex-col">
                        <div class="bg-blue-50 p-2 text-[10px] text-blue-800 mb-2 rounded border border-blue-100">Log Evidence here. Add a URL to your OneDrive file to make it clickable in the Report.</div>
                        <div class="mb-2">
                            <textarea x-model="newUpdateText" class="w-full border p-2 rounded text-xs h-12 mb-1" placeholder="Describe evidence/update..."></textarea>
                            <div class="flex gap-2 mb-1">
                                <select x-model="newUpdateSource" class="border p-2 rounded text-xs w-1/3"><option value="">- Source -</option><template x-for="s in settings.qaSources"><option :value="s" x-text="s"></option></template></select>
                                <input x-model="newUpdateLink" placeholder="Link to file (https://...)" class="flex-1 border p-2 rounded text-xs">
                            </div>
                            <button @click="addUpdate()" class="bg-emerald-600 text-white px-4 py-2 rounded text-xs font-bold w-full">Add Evidence</button>
                        </div>
                        <div class="space-y-2 overflow-y-auto max-h-[300px] flex-1 bg-slate-50 p-2 rounded border"><template x-for="(u, idx) in currentProject.updates" :key="idx"><div class="bg-white p-2 rounded shadow-sm border border-slate-100 text-xs"><div class="flex justify-between text-slate-400 text-[10px] mb-1"><span x-text="formatDate(u.date)"></span><span x-text="u.source" class="font-bold text-slate-500"></span><button @click="currentProject.updates.splice(idx, 1)" class="hover:text-red-500"><i class="fas fa-times"></i></button></div><div x-text="u.text" class="font-medium text-slate-700 mb-1 whitespace-pre-wrap"></div><a x-show="u.link" :href="u.link" target="_blank" class="text-blue-600 underline">Evidence Link</a></div></template></div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end gap-2"><button @click="showModal = false" class="px-4 py-2 text-slate-500">Cancel</button><button @click="saveProject()" class="px-4 py-2 bg-blue-600 text-white rounded">Save Project</button></div>
        </div>
    </div>

    <script>
        function appData() {
            return {
                view: 'dashboard', dashboardMode: 'strategy', fileHandle: null, showModal: false, modalTab: 'tasks', activeStrategyTab: 0, reportTab: 'overview', timelineTab: 'all',
                searchQuery: '', filterRag: '', filterType: '', filterPriority: '', filterKpi: '',
                newTodo: '', newUpdateText: '', newUpdateLink: '', newUpdateSource: '',
                timelineMode: 'year',
                projects: [], todos: [], settings: { priorities: [], kpis: [], qaSources: [] }, currentProject: {}, charts: {}, 

                async init() {
                    // Pre-populate if empty (These can be updated anytime)
                    this.settings.kpis = ['Teaching Quality Indicators', 'QIP Traction', 'Staff Capability', 'Staff Confidence', 'Student Experience', 'Retention Proxy', 'Value for Money', 'Digital Champions'];
                    this.settings.qaSources = ['Learning Walk Data', 'TLA Profile', 'QIP Review', 'Coaching Record', 'Staff Survey', 'Learner Voice', 'Exit Interview', 'Teams Analytics', 'Other'];
                },
                async openFile() {
                    try {
                        const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON Data', accept: { 'application/json': ['.json'] } }], multiple: false });
                        this.fileHandle = handle; const file = await handle.getFile(); const text = await file.text();
                        if (text.trim()) {
                            const data = JSON.parse(text);
                            this.projects = (data.projects || []).map(p => ({ ...p, milestones: (p.milestones || []).map(m => ({...m, uuid: m.uuid || Date.now() + Math.random()})), updates: p.updates || [], deptCode: p.deptCode||'', tlam: p.tlam||'', kpi: p.kpi||'', qaLink: p.qaLink||'', isQip: p.isQip||false }));
                            this.todos = (data.todos || []).map(t => ({...t, originalId: t.originalId || null})); 
                            this.settings.priorities = (data.settings?.priorities || []).map((p,i) => ({ ...p, id: p.id||(i+1), strategicMilestones: p.strategicMilestones||[], tasks: p.tasks||[] }));
                            // Ensure KPI lists exist in loaded settings or fallback
                            this.settings.kpis = data.settings?.kpis || this.settings.kpis;
                            this.settings.qaSources = data.settings?.qaSources || this.settings.qaSources;
                            
                            this.$nextTick(() => this.initCharts());
                        }
                    } catch (err) { console.error(err); alert("Error connecting."); }
                },
                async saveToFile() {
                    if (!this.fileHandle) return;
                    try {
                        const writable = await this.fileHandle.createWritable();
                        await writable.write(JSON.stringify({ projects: this.projects, settings: this.settings, todos: this.todos }, null, 2));
                        await writable.close();
                        if(this.view === 'dashboard' && document.getElementById('priorityChart')) this.updateCharts();
                    } catch (err) { console.error('Save failed', err); }
                },

                // --- GANTT ENGINE ---
                get timelineColumns() {
                    const today = new Date(); const cols = [];
                    if (this.timelineMode === 'year') {
                        const currentYear = today.getFullYear();
                        for(let i=0; i<12; i++) { const d = new Date(currentYear, i, 1); cols.push({ label: d.toLocaleString('default', {month:'short'}), sub: d.getFullYear(), start: d, end: new Date(currentYear, i+1, 0) }); }
                    } else if (this.timelineMode === '6m') {
                        for(let i=0; i<6; i++) { const d = new Date(today.getFullYear(), today.getMonth() + i, 1); cols.push({ label: d.toLocaleString('default', {month:'short'}), sub: d.getFullYear(), start: d, end: new Date(d.getFullYear(), d.getMonth()+1, 0) }); }
                    } else if (this.timelineMode === '3m') {
                        const start = new Date(today); start.setDate(today.getDate() - today.getDay() + 1); 
                        for(let i=0; i<12; i++) { const wStart = new Date(start); wStart.setDate(start.getDate() + (i*7)); const wEnd = new Date(wStart); wEnd.setDate(wStart.getDate() + 6); cols.push({ label: 'W' + (i+1), sub: wStart.getDate() + '/' + (wStart.getMonth()+1), start: wStart, end: wEnd }); }
                    } else if (this.timelineMode === '1m') {
                        for(let i=0; i<30; i++) { const d = new Date(today); d.setDate(today.getDate() + i); cols.push({ label: d.getDate(), sub: d.toLocaleString('default',{weekday:'short'}), start: new Date(d.setHours(0,0,0,0)), end: new Date(d.setHours(23,59,59,999)) }); }
                    }
                    return cols;
                },
                getTimelineGridStyle() { return `grid-template-columns: 250px repeat(${this.timelineColumns.length}, minmax(${this.timelineMode === '1m' ? '30px' : '50px'}, 1fr));`; },
                getDynamicGanttBarStyle(p, idx) {
                    const pStart = new Date(p.startDate); const pEnd = new Date(p.endDate); const cols = this.timelineColumns;
                    if (!this.hasDates(p)) return 'display:none';
                    let startIndex = -1; let endIndex = -1;
                    for(let i=0; i<cols.length; i++) { if (pStart <= cols[i].end && startIndex === -1) startIndex = i; if (pEnd >= cols[i].start) endIndex = i; }
                    if (endIndex < 0 || startIndex === -1 || pEnd < cols[0].start || pStart > cols[cols.length-1].end) return 'display:none';
                    const gridStart = Math.max(0, startIndex) + 2; const span = (Math.min(cols.length - 1, endIndex) - Math.max(0, startIndex)) + 1;
                    return `grid-column: ${gridStart} / span ${span}; grid-row: ${idx + 2}; align-self: center;`;
                },
                isProjectVisibleInTimeline(p) { return !this.getDynamicGanttBarStyle(p, 0).includes('display:none'); },

                // --- Standard Logic ---
                copyToToday(task, proj) {
                    if (!task.uuid) task.uuid = Date.now() + Math.random().toString(16).slice(2);
                    if(this.todos.find(t => t.originalId === task.uuid)) return alert("Already in Today's list");
                    this.todos.push({ text: task.title, completed: task.completed, projectTitle: proj.title, originalId: task.uuid, projectId: proj.id });
                    this.saveToFile(); alert("Added to Dashboard.");
                },
                syncFromDashboard(todo) {
                    const proj = this.projects.find(p => p.id === todo.projectId);
                    if(proj) { const task = proj.milestones.find(m => m.uuid === todo.originalId); if(task) { task.completed = todo.completed; if(task.completed) { task.completedDate = new Date().toISOString(); confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } }); } else { task.completedDate = null; } } }
                    this.saveToFile();
                },
                syncFromProject(task, proj) {
                    if(!task.uuid) task.uuid = Date.now() + Math.random().toString(16).slice(2); 
                    if(task.completed) { task.completedDate = new Date().toISOString(); confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } }); } else { task.completedDate = null; }
                    const todo = this.todos.find(t => t.originalId === task.uuid); if(todo) todo.completed = task.completed;
                    this.saveToFile();
                },
                deleteTodo(idx) { this.todos.splice(idx, 1); this.saveToFile(); },
                getReportTabIds() { return this.settings.priorities.map(p => p.id).concat(['standalone']); },
                getReportTitle(pId) {
                    if(pId === 'standalone') return 'Stand-alone Projects';
                    const p = this.settings.priorities.find(x => x.id === pId); return p ? p.title : 'Unknown';
                },
                getProjectsForReport(pId) { if(pId === 'standalone') return this.projects.filter(p => !p.priorityId); return this.projects.filter(p => p.priorityId === pId); },
                calculatePriorityTotalProgress(pId) {
                    const projs = this.getProjectsForReport(pId); if (projs.length === 0) return 0;
                    const total = projs.reduce((acc, p) => acc + this.calculateProgress(p), 0); return Math.round(total / projs.length);
                },
                calculateMilestoneProgress(pId, mTitle) {
                    const projs = this.getProjectsForMilestone(pId, mTitle); if (projs.length === 0) return 0;
                    const total = projs.reduce((acc, p) => acc + this.calculateProgress(p), 0); return Math.round(total / projs.length);
                },
                addPriority() { this.settings.priorities.push({ id: Date.now(), title: 'New Priority', details: '', strategicMilestones: [], tasks: [] }); this.activeStrategyTab = this.settings.priorities.length - 1; },
                createProjectFromAction(priority, milestone) {
                    const name = prompt("Enter Name:", milestone.title); if(!name) return;
                    const newProj = { id: Date.now(), title: name, priorityId: priority.id, milestoneLink: milestone.title, type: 'Strategy', status: 'Active', startDate: new Date().toISOString().split('T')[0], endDate: milestone.targetDate || '', milestones: [], updates: [{date: new Date().toISOString(), text: 'Initialized.'}], deptCode: '', tlam: '', kpi: '', qaLink: '', isQip: false };
                    this.projects.push(newProj); this.saveToFile(); alert(`Project created.`);
                },
                resetFilters() { this.searchQuery=''; this.filterRag=''; this.filterType=''; this.filterPriority=''; this.filterKpi=''; },
                addTodo() { if(this.newTodo) { this.todos.push({text: this.newTodo, completed: false, projectTitle: 'Manual'}); this.newTodo = ''; this.saveToFile(); }},
                addUpdate() { if(this.newUpdateText) { this.currentProject.updates.push({ date: new Date().toISOString(), text: this.newUpdateText, link: this.newUpdateLink, source: this.newUpdateSource }); this.newUpdateText = ''; this.newUpdateLink = ''; this.newUpdateSource = ''; }},
                getMonthName(m) { const d = new Date(); d.setMonth(m-1); return d.toLocaleString('default', { month: 'short' }); },
                hasDates(p) { return p.startDate && p.endDate; },
                getPriorityColor(pId) { if(!pId) return 'bg-slate-500'; const idx = this.settings.priorities.findIndex(p => p.id == pId); return this.getHeaderColor(idx).replace('bg-', 'bg-').replace('-600', '-500'); },
                addStratMilestone(p) { if(!p.strategicMilestones) p.strategicMilestones = []; p.strategicMilestones.push({ title: 'New Phase', targetDate: '', status: 'Planned' }); },
                addStrategyTask(p) { if(!p.tasks) p.tasks=[]; p.tasks.push({name:'New Task', completed:false}); },
                getMilestonesForPriority(pId) { const p = this.settings.priorities.find(x => x.id == pId); return p ? p.strategicMilestones : []; },
                getProjectsForMilestone(pId, mTitle) { return this.projects.filter(p => p.priorityId == pId && p.milestoneLink == mTitle); },
                getProjectsForPriority(pId) { return this.projects.filter(p => p.priorityId == pId); },
                getProjectStrategyName(p) { if (!p.priorityId) return null; const prio = this.settings.priorities.find(x => x.id == p.priorityId); if (!prio) return null; return p.milestoneLink ? p.milestoneLink : prio.title; },
                getAllDueTasks() { let all = []; this.projects.forEach(p => (p.milestones||[]).forEach(m => { if (!m.completed && m.dueDate) all.push({id:Math.random(), projectId:p.id, projectName:p.title, title:m.title, dueDate:m.dueDate, context:'Task', isStrategy: false}); })); return all.sort((a,b)=>a.dueDate.localeCompare(b.dueDate)).slice(0, 30); },
                formatDate(d) { return d ? new Date(d).toLocaleDateString('en-GB') : ''; },
                formatDateShort(d) { return d ? new Date(d).toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit'}) : ''; },
                getHeaderColor(idx) { return ['bg-blue-600', 'bg-amber-500', 'bg-emerald-600', 'bg-purple-600', 'bg-pink-600'][idx % 5]; },
                getHeaderTextColor(idx) { return ['text-blue-600', 'text-amber-500', 'text-emerald-600', 'text-purple-600', 'text-pink-600'][idx % 5]; },
                getProjectHeaderColor(pId) { if(!pId) return 'bg-slate-500'; const idx = this.settings.priorities.findIndex(p => p.id == pId); return idx !== -1 ? this.getHeaderColor(idx) : 'bg-slate-500'; },
                getRagBorder(dateStr) { if (!dateStr) return 'border-slate-200'; const today = new Date(); today.setHours(0,0,0,0); const due = new Date(dateStr); const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24)); if (diffDays < 0) return 'border-red-600 border-l-4'; if (diffDays <= 7) return 'border-red-500 border-l-4'; if (diffDays <= 14) return 'border-orange-400 border-l-4'; return 'border-green-500 border-l-4'; },
                switchView(v) { this.view = v; if(v==='dashboard') setTimeout(()=>this.updateCharts(),100); },
                startNewProject() { this.currentProject = { id: Date.now(), title: '', priorityId: '', milestoneLink: '', type: 'coaching', milestones: [], updates: [], status: 'Active', deptCode: '', tlam: '', startDate: '', endDate: '' }; this.showModal = true; this.modalTab = 'tasks'; },
                editProject(p) { this.currentProject = p; this.showModal = true; this.modalTab = 'tasks'; }, 
                saveProject() { const idx = this.projects.findIndex(x => x.id === this.currentProject.id); if(idx === -1) this.projects.push(this.currentProject); this.saveToFile(); this.showModal = false; },
                addMilestone() { if(!this.currentProject.milestones) this.currentProject.milestones=[]; this.currentProject.milestones.push({title:'New Task', completed:false, completedDate: null, uuid: Date.now() + Math.random().toString(16).slice(2)}); },
                
                get filteredProjects() { return this.projects.filter(p => { 
                    const matchesSearch = p.title.toLowerCase().includes(this.searchQuery.toLowerCase()); 
                    if(this.filterRag) { const border = this.getRagBorder(p.endDate); if(!border.includes(this.filterRag)) return false; } 
                    if(this.filterType && p.type && p.type.toLowerCase() !== this.filterType.toLowerCase()) return false; 
                    if(this.filterPriority) { if(this.filterPriority === 'standalone') { if(p.priorityId) return false; } else if(p.priorityId != this.filterPriority) return false; }
                    if(this.filterKpi && p.kpi !== this.filterKpi) return false;
                    return matchesSearch; 
                }); },
                get timelineProjects() {
                    const all = this.filteredProjects;
                    if (this.timelineTab === 'all') return all;
                    if (this.timelineTab === 'standalone') return all.filter(p => !p.priorityId);
                    return all.filter(p => p.priorityId === this.timelineTab);
                },

                calculateProgress(p) { return !p.milestones?.length ? 0 : Math.round((p.milestones.filter(m=>m.completed).length / p.milestones.length)*100); },
                exportToExcel() {
                    let csvContent = "data:text/csv;charset=utf-8,Priority,Project Title,KPI,QA Mechanism,Start Date,End Date,Status,Completion %\n";
                    this.projects.forEach(p => {
                        const prioTitle = p.priorityId ? (this.settings.priorities.find(pri => pri.id == p.priorityId)?.title || 'Standalone') : 'Standalone';
                        const progress = this.calculateProgress(p);
                        const row = `"${prioTitle}","${p.title}","${p.kpi}","${p.qaLink}","${p.startDate}","${p.endDate}","${p.status}","${progress}%"`;
                        csvContent += row + "\n";
                    });
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", "project_data.csv");
                    document.body.appendChild(link);
                    link.click();
                },

                initCharts() {
                    const pCtx = document.getElementById('priorityChart')?.getContext('2d');
                    const pipeCtx = document.getElementById('pipelineChart')?.getContext('2d');
                    // We re-initialize charts on update for simplicity in this version
                    if(this.charts.priority) this.charts.priority.destroy();
                    if(this.charts.pipeline) this.charts.pipeline.destroy();

                    const isGov = this.dashboardMode === 'governance';
                    const pData = isGov ? this.getKpiData() : this.getPriorityData();

                    if(pCtx) this.charts.priority = new Chart(pCtx, { type: 'doughnut', data: pData, options: { responsive: true, maintainAspectRatio: false, onClick: (e, el) => { if(el.length > 0) this.switchView('projects'); } } });
                    if(pipeCtx) this.charts.pipeline = new Chart(pipeCtx, { type: 'bar', data: this.getPipelineData(), options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, onClick: (e, el) => { if(el.length > 0) this.switchView('projects'); } } });
                },
                updateCharts() { this.initCharts(); },
                getPriorityData() { return { labels: this.settings.priorities.map(p => (p.title || 'Untitled').substring(0, 15)+'...'), datasets: [{ data: this.settings.priorities.map(p => this.projects.filter(proj => proj.priorityId == p.id).length), backgroundColor: ['#2563eb', '#f59e0b', '#059669', '#7c3aed', '#db2777'], borderWidth: 0 }] }; },
                getKpiData() { return { labels: this.settings.kpis.map(k => k.substring(0, 15)+'...'), datasets: [{ data: this.settings.kpis.map(k => this.projects.filter(p => p.kpi == k).length), backgroundColor: ['#9333ea', '#c084fc', '#a855f7', '#7e22ce', '#6b21a8', '#581c87', '#3b0764', '#d8b4fe'], borderWidth: 0 }] }; },
                getPipelineData() { return { labels: ['Active Cases', 'Completed Cases'], datasets: [{ label: 'Projects', data: [this.projects.filter(p => p.status !== 'Completed').length, this.projects.filter(p => p.status === 'Completed').length], backgroundColor: ['#3b82f6', '#10b981'] }] }; },
            }
        }
    </script>
</body>
</html>
